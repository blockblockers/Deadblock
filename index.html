<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#020617" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DEADBLOCK" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="DEADBLOCK" />
  
  <!-- Primary SEO -->
  <title>DEADBLOCK - Strategic Block Puzzle Game</title>
  <meta name="description" content="DEADBLOCK - Strategic pentomino placement puzzle game. Challenge the AI, solve puzzles, or compete with friends online!" />
  <meta name="keywords" content="puzzle game, pentomino, block puzzle, strategy game, multiplayer game, online puzzle, brain game, tetris-like" />
  <meta name="author" content="Deadblock" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://deadblock.app/" />
  
  <!-- Open Graph (Facebook, LinkedIn, Discord) -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://deadblock.app/" />
  <meta property="og:title" content="DEADBLOCK - Strategic Block Puzzle Game" />
  <meta property="og:description" content="Challenge friends or AI in this strategic pentomino placement puzzle game. Play online multiplayer, solve puzzles, and climb the leaderboards!" />
  <meta property="og:image" content="https://deadblock.app/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:site_name" content="Deadblock" />
  <meta property="og:locale" content="en_US" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://deadblock.app/" />
  <meta name="twitter:title" content="DEADBLOCK - Strategic Block Puzzle Game" />
  <meta name="twitter:description" content="Challenge friends or AI in this strategic pentomino placement puzzle game. Play online multiplayer!" />
  <meta name="twitter:image" content="https://deadblock.app/og-image.png" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json" />
  
  <!-- Favicon & Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16.png" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  
  <style>
    :root {
      --neon-cyan: #22d3ee;
      --neon-purple: #a855f7;
      --neon-pink: #ec4899;
      --dark-bg: #0f172a;
      --darker-bg: #020617;
      --sat: env(safe-area-inset-top);
      --sar: env(safe-area-inset-right);
      --sab: env(safe-area-inset-bottom);
      --sal: env(safe-area-inset-left);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      overflow: hidden;
      overscroll-behavior: none;
      touch-action: manipulation;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--darker-bg);
      color: white;
      min-height: 100vh;
      min-height: 100dvh;
      padding: var(--sat) var(--sar) var(--sab) var(--sal);
    }

    #root {
      min-height: 100vh;
      min-height: 100dvh;
    }

    /* Loading Screen */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--darker-bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    #loading::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: 
        linear-gradient(rgba(34, 211, 238, 0.15) 1px, transparent 1px), 
        linear-gradient(90deg, rgba(34, 211, 238, 0.15) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity: 0.5;
      animation: grid-pulse 4s ease-in-out infinite;
    }
    
    @keyframes grid-pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }
    
    #loading .glow-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      pointer-events: none;
    }
    
    #loading .glow-orb-1 {
      top: 20%;
      left: 20%;
      width: 200px;
      height: 200px;
      background: var(--neon-pink);
      opacity: 0.2;
      animation: orb-float-1 8s ease-in-out infinite;
    }
    
    #loading .glow-orb-2 {
      bottom: 20%;
      right: 20%;
      width: 180px;
      height: 180px;
      background: var(--neon-cyan);
      opacity: 0.2;
      animation: orb-float-2 10s ease-in-out infinite;
    }
    
    @keyframes orb-float-1 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(30px, -20px) scale(1.1); }
    }
    
    @keyframes orb-float-2 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(-20px, 20px) scale(0.9); }
    }

    .neon-title {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(2.5rem, 10vw, 4rem);
      font-weight: 900;
      letter-spacing: 0.15em;
      background: linear-gradient(135deg, var(--neon-cyan) 0%, var(--neon-purple) 50%, var(--neon-pink) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: none;
      filter: drop-shadow(0 0 8px rgba(34, 211, 238, 0.8)) 
              drop-shadow(0 0 20px rgba(168, 85, 247, 0.6)) 
              drop-shadow(0 0 40px rgba(236, 72, 153, 0.4));
      animation: neon-glow 2s ease-in-out infinite alternate;
    }

    @keyframes neon-glow {
      from { 
        filter: drop-shadow(0 0 8px rgba(34, 211, 238, 0.8)) 
                drop-shadow(0 0 20px rgba(168, 85, 247, 0.6)) 
                drop-shadow(0 0 40px rgba(236, 72, 153, 0.4));
      }
      to { 
        filter: drop-shadow(0 0 12px rgba(34, 211, 238, 1)) 
                drop-shadow(0 0 30px rgba(168, 85, 247, 0.8)) 
                drop-shadow(0 0 60px rgba(236, 72, 153, 0.6));
      }
    }

    .subtitle {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      letter-spacing: 0.5em;
      color: rgba(148, 163, 184, 0.8);
      text-transform: uppercase;
      margin-top: 10px;
    }

    .loading-bar-container {
      width: 200px;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      margin-top: 30px;
      overflow: hidden;
    }

    .loading-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple), var(--neon-pink));
      border-radius: 2px;
      animation: loading-progress 2s ease-in-out forwards;
    }

    @keyframes loading-progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    .loading-text {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.7rem;
      letter-spacing: 0.3em;
      color: var(--neon-cyan);
      margin-top: 15px;
      animation: blink 1s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Scanline effect */
    .scanlines {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 10000;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.03) 2px,
        rgba(0, 0, 0, 0.03) 4px
      );
      opacity: 0.5;
    }

    /* PWA Install Prompt */
    #install-prompt {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      max-width: 360px;
      margin: 0 auto;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.95));
      border: 1px solid rgba(34, 211, 238, 0.3);
      border-radius: 16px;
      box-shadow: 0 0 30px rgba(34, 211, 238, 0.2), 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 9998;
      transform: translateY(200%);
      opacity: 0;
      transition: transform 0.4s ease, opacity 0.4s ease;
    }

    #install-prompt.show {
      transform: translateY(0);
      opacity: 1;
    }

    .prompt-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--neon-cyan);
      letter-spacing: 0.1em;
      margin-bottom: 6px;
    }

    .prompt-text {
      font-size: 0.85rem;
      color: rgba(148, 163, 184, 0.9);
      margin-bottom: 14px;
    }

    .btn-container {
      display: flex;
      gap: 10px;
    }

    #install-prompt button {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #install-btn {
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      color: white;
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
    }

    #install-btn:hover, #install-btn:active {
      box-shadow: 0 0 30px rgba(168, 85, 247, 0.6);
      transform: scale(1.02);
    }

    #dismiss-btn {
      background: rgba(100, 116, 139, 0.3);
      color: rgba(226, 232, 240, 0.7);
      border: 1px solid rgba(100, 116, 139, 0.5);
    }

    #dismiss-btn:hover, #dismiss-btn:active {
      background: rgba(100, 116, 139, 0.5);
      color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .neon-title {
        font-size: 2.5rem;
      }
      
      .subtitle {
        font-size: 0.75rem;
        letter-spacing: 0.3em;
      }
    }
  </style>
</head>
<body>
  <!-- Scanline overlay for retro CRT effect -->
  <div class="scanlines"></div>
  
  <!-- Loading Screen -->
  <div id="loading">
    <div class="glow-orb glow-orb-1"></div>
    <div class="glow-orb glow-orb-2"></div>
    <h1 class="neon-title">DEADBLOCK</h1>
    <p class="subtitle">Block Puzzle Strategy</p>
    <div class="loading-bar-container">
      <div class="loading-bar"></div>
    </div>
    <p class="loading-text">INITIALIZING...</p>
  </div>
  
  <!-- App Root -->
  <div id="root"></div>
  
  <!-- Install Prompt (only shown on web, hidden in native apps) -->
  <div id="install-prompt">
    <p class="prompt-title">INSTALL DEADBLOCK</p>
    <p class="prompt-text">Add to your home screen for the full experience!</p>
    <div class="btn-container">
      <button id="install-btn">INSTALL</button>
      <button id="dismiss-btn">LATER</button>
    </div>
    <button id="already-installed-btn" style="
      margin-top: 10px;
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #94a3b8;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      width: 100%;
    ">Already installed? Click here</button>
  </div>
  
  <script type="module" src="/src/main.jsx"></script>
  
  <script>
    // =====================================================
    // PWA INSTALL PROMPT LOGIC
    // =====================================================
    
    const pwaDebug = false;
    const pwaLog = (msg) => { if (pwaDebug) console.log('[PWA]', msg); };
    
    let deferredPrompt = null;
    let appIsInstalled = false;
    const installPrompt = document.getElementById('install-prompt');
    
    // Check if running as native app (Capacitor)
    const isNativeApp = window.Capacitor?.isNativePlatform?.() || false;
    
    // Check if already in standalone mode
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                         window.navigator.standalone === true ||
                         document.referrer.includes('android-app://');
    
    // Check localStorage for previous installation
    const wasInstalled = localStorage.getItem('pwa-was-installed') === 'true';
    
    if (isNativeApp || isStandalone || wasInstalled) {
      pwaLog('Running as installed app or native - hiding prompt');
      appIsInstalled = true;
    }
    
    // Check using getInstalledRelatedApps API
    async function checkIfInstalled() {
      if ('getInstalledRelatedApps' in navigator) {
        try {
          const apps = await navigator.getInstalledRelatedApps();
          return apps.length > 0;
        } catch (e) {
          return false;
        }
      }
      return false;
    }
    
    // Show manual install instructions for Safari/iOS
    function showManualInstructions() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      
      if (isIOS || isSafari) {
        const promptText = document.querySelector('.prompt-text');
        if (promptText) {
          promptText.innerHTML = isIOS 
            ? 'Tap <strong>Share</strong> then <strong>"Add to Home Screen"</strong>'
            : 'Click the share button and select <strong>"Add to Dock"</strong>';
        }
        const installBtn = document.getElementById('install-btn');
        if (installBtn) {
          installBtn.textContent = 'GOT IT';
          installBtn.onclick = () => {
            installPrompt.classList.remove('show');
            localStorage.setItem('pwa-install-dismissed', Date.now().toString());
          };
        }
        installPrompt.classList.add('show');
      }
    }
    
    // Capture the install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      pwaLog('beforeinstallprompt fired');
      e.preventDefault();
      deferredPrompt = e;
      
      // Don't show if already installed
      if (appIsInstalled) {
        pwaLog('App already installed - not showing prompt');
        return;
      }
      
      // Check dismiss cooldown (7 days)
      const dismissed = localStorage.getItem('pwa-install-dismissed');
      if (dismissed) {
        const dismissedTime = parseInt(dismissed, 10);
        const sevenDays = 7 * 24 * 60 * 60 * 1000;
        if (Date.now() - dismissedTime < sevenDays) {
          pwaLog('Prompt dismissed recently - waiting');
          return;
        }
      }
      
      // Show prompt after short delay
      setTimeout(() => {
        if (!appIsInstalled) {
          installPrompt.classList.add('show');
          pwaLog('Showing install prompt');
        }
      }, 3000);
    });
    
    // Handle install button
    document.getElementById('install-btn')?.addEventListener('click', async () => {
      if (!deferredPrompt) {
        pwaLog('No deferred prompt - showing manual instructions');
        showManualInstructions();
        return;
      }
      
      pwaLog('Triggering install prompt');
      installPrompt.classList.remove('show');
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      pwaLog('Install outcome: ' + outcome);
      
      if (outcome === 'accepted') {
        appIsInstalled = true;
        localStorage.setItem('pwa-was-installed', 'true');
      }
      
      deferredPrompt = null;
    });
    
    // Handle dismiss button
    document.getElementById('dismiss-btn')?.addEventListener('click', () => {
      pwaLog('User dismissed prompt');
      installPrompt.classList.remove('show');
      
      // Track dismiss count
      const dismissCount = parseInt(localStorage.getItem('pwa-dismiss-count') || '0', 10) + 1;
      localStorage.setItem('pwa-dismiss-count', dismissCount.toString());
      
      // After 2 dismissals, don't show again
      if (dismissCount >= 2) {
        pwaLog('Dismissed twice - permanent dismiss');
        localStorage.setItem('pwa-was-installed', 'true');
        localStorage.setItem('pwa-install-dismissed', (Date.now() + 10 * 365 * 24 * 60 * 60 * 1000).toString());
      } else {
        pwaLog('Dismissed (' + dismissCount + '/2) - will show again in 7 days');
        localStorage.setItem('pwa-install-dismissed', Date.now().toString());
      }
    });

    // Handle "Already Installed" / permanent dismiss
    const alreadyInstalledBtn = document.getElementById('already-installed-btn');
    if (alreadyInstalledBtn) {
      alreadyInstalledBtn.addEventListener('click', () => {
        pwaLog('User marked as already installed - permanent dismiss');
        installPrompt.classList.remove('show');
        appIsInstalled = true;
        // Permanently mark as installed
        localStorage.setItem('pwa-was-installed', 'true');
        // Also set dismissed far in the future
        localStorage.setItem('pwa-install-dismissed', (Date.now() + 10 * 365 * 24 * 60 * 60 * 1000).toString());
      });
    }

    // App installed
    window.addEventListener('appinstalled', () => {
      pwaLog('App installed!');
      appIsInstalled = true;
      installPrompt.classList.remove('show');
      deferredPrompt = null;
      // Persist installation state
      try {
        localStorage.setItem('pwa-was-installed', 'true');
      } catch (e) {}
    });

    // Debug helpers
    window.showInstallPrompt = () => {
      localStorage.removeItem('pwa-install-dismissed');
      localStorage.removeItem('pwa-was-installed');
      appIsInstalled = false;
      if (deferredPrompt) {
        installPrompt.classList.add('show');
      } else {
        showManualInstructions();
      }
    };

    window.checkPWA = async () => {
      pwaLog('=== PWA Debug ===');
      pwaLog('Protocol: ' + location.protocol);
      pwaLog('Hostname: ' + location.hostname);
      pwaLog('Native app: ' + isNativeApp);
      pwaLog('Standalone: ' + isStandalone);
      pwaLog('App installed (tracked): ' + appIsInstalled);
      pwaLog('Deferred prompt: ' + (deferredPrompt ? 'YES' : 'NO'));
      
      // Check using getInstalledRelatedApps API
      const apiInstalled = await checkIfInstalled();
      pwaLog('App installed (API check): ' + apiInstalled);
      
      // Check manifest
      try {
        const resp = await fetch('/manifest.json');
        const manifest = await resp.json();
        pwaLog('Manifest: ' + manifest.name);
        pwaLog('Icons: ' + manifest.icons?.length);
      } catch (e) {
        pwaLog('Manifest error: ' + e);
      }
      
      // Check service worker
      if ('serviceWorker' in navigator) {
        const reg = await navigator.serviceWorker.getRegistration();
        pwaLog('SW registered: ' + (reg ? 'YES' : 'NO'));
      }
    };

    // =====================================================
    // HIDE LOADING SCREEN AFTER REACT MOUNTS
    // =====================================================
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const loading = document.getElementById('loading');
        if (loading) {
          loading.style.opacity = '0';
          loading.style.transition = 'opacity 0.5s ease';
          setTimeout(() => loading.style.display = 'none', 500);
        }
      }, 1500);
    });

    // Prevent pull-to-refresh
    let lastTouchY = 0;
    document.addEventListener('touchstart', (e) => {
      lastTouchY = e.touches[0].clientY;
    }, { passive: true });
    document.addEventListener('touchmove', (e) => {
      const touchY = e.touches[0].clientY;
      if (window.scrollY === 0 && touchY > lastTouchY && e.cancelable) {
        e.preventDefault();
      }
      lastTouchY = touchY;
    }, { passive: false });
  </script>
</body>
</html>
