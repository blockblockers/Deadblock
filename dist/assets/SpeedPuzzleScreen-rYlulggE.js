import{r as t,c as lt,u as It,b as ie,d as ee,B as L,s as g,e as Mt,f as Gt,h as de,j as e,D as Lt,G as Ot,i as Dt,C as Bt,k as _t,F as Yt,T as Ye,Z as Wt,R as We,H as at,l as R}from"./index-8HZmLUul.js";import{T as ct}from"./timer-CKvbxT7p.js";import{P as Xt}from"./play-CKcjBX8x.js";const we=10,$t=50,Ht=500,qt=100,Ft=50,Ut=5,Vt=500,Oe={LOW:3,CRITICAL:2,URGENT:1},De={HOT:3,ON_FIRE:5,LEGENDARY:10},i={LOADING:"loading",PLAYING:"playing",SUCCESS:"success",GAMEOVER:"gameover",ERROR:"error"},Be={BEST_STREAK:"speed-puzzle-best"},Se={gridColor:"rgba(239,68,68,0.4)",glow1:"bg-red-500/40",glow2:"bg-orange-500/30"},Zt={up:[-1,0],down:[1,0],left:[0,-1],right:[0,1]},Kt=(l,d)=>{try{const s=localStorage.getItem(l);return s!==null?parseInt(s,10):d}catch{return d}},ot=(l,d)=>{try{return localStorage.setItem(l,d.toString()),!0}catch{return!1}},it=()=>Array(L).fill(null).map(()=>Array(L).fill(null)),_e=l=>{const d=lt(),s=it();for(let f=0;f<64;f++){const w=l[f];if(w!=="G"){const S=Math.floor(f/L),u=f%L;d[S][u]=1,s[S][u]=w==="H"?"Y":w}}return{newBoard:d,newBoardPieces:s}},Xe=t.memo(({timeLeft:l,maxTime:d})=>{const s=l/d*100,f=l<=Oe.LOW,w=l<=Oe.CRITICAL,S=l<=Oe.URGENT,u=t.useMemo(()=>S?"#ef4444":w?"#f97316":f?"#fbbf24":"#22d3ee",[S,w,f]),te=2*Math.PI*12;return e.jsxs("div",{className:`
        relative flex items-center gap-2 px-3 py-1.5 rounded-full 
        bg-slate-900/90 border transition-all duration-200
        ${S?"animate-timer-shake border-red-500/70":w?"animate-timer-critical border-orange-500/60":f?"animate-timer-pulse border-amber-500/50":"border-cyan-500/40"}
      `,style:{boxShadow:`0 0 ${S?"20":w?"15":"10"}px ${u}60`},children:[e.jsxs("div",{className:"relative w-8 h-8",children:[e.jsxs("svg",{className:"w-full h-full transform -rotate-90",children:[e.jsx("circle",{cx:"16",cy:"16",r:"12",fill:"none",stroke:"rgba(100,116,139,0.3)",strokeWidth:"3"}),e.jsx("circle",{cx:"16",cy:"16",r:"12",fill:"none",stroke:u,strokeWidth:"3",strokeLinecap:"round",strokeDasharray:te,strokeDashoffset:te*(1-s/100),className:"transition-all duration-100",style:{filter:`drop-shadow(0 0 4px ${u})`}})]}),e.jsx(ct,{size:14,className:"absolute inset-0 m-auto transition-colors",style:{color:u}})]}),e.jsx("div",{className:`font-black tabular-nums text-xl transition-all ${S?"scale-110":""}`,style:{color:u,textShadow:`0 0 10px ${u}`},children:l.toFixed(1)}),e.jsx("div",{className:"flex gap-0.5",children:[1,2,3].map(D=>e.jsx("div",{className:`w-1.5 h-1.5 rounded-full transition-all duration-200 ${l<=D?"bg-red-500":l<=D+2?"bg-amber-500":"bg-cyan-500/50"}`,style:{boxShadow:l<=D?"0 0 6px #ef4444":"none"}},D))})]})});Xe.displayName="SpeedTimer";Xe.propTypes={timeLeft:R.number.isRequired,maxTime:R.number.isRequired};const $e=t.memo(({streak:l,isNewRecord:d,bestStreak:s=0})=>{const f=l>=De.HOT,w=l>=De.ON_FIRE,S=l>=De.LEGENDARY,u=t.useMemo(()=>S?"#fbbf24":w?"#f97316":f?"#fb923c":"#94a3b8",[S,w,f]);return e.jsxs("div",{className:`
        flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900/90 border transition-all duration-300
        ${S?"border-amber-400/60":w?"border-orange-500/50":f?"border-orange-400/40":"border-slate-700/50"}
      `,style:{boxShadow:f?`0 0 ${S?"20":w?"15":"10"}px ${u}40`:"none"},children:[e.jsx("div",{className:"relative",children:e.jsx(Yt,{size:18,className:`transition-all duration-300 ${w?"animate-bounce":""}`,style:{color:u,filter:f?`drop-shadow(0 0 4px ${u})`:"none"}})}),e.jsx("div",{className:"font-black tabular-nums text-lg",style:{color:u,textShadow:f?`0 0 10px ${u}`:"none"},children:l}),s>0&&!d&&l<s&&e.jsxs("div",{className:"flex items-center gap-1 px-1.5 py-0.5 rounded bg-slate-700/50 border border-slate-600/50",children:[e.jsx(Ye,{size:10,className:"text-slate-400"}),e.jsx("span",{className:"text-slate-400 text-[10px] font-medium",children:s})]}),d&&l>0&&e.jsxs("div",{className:"flex items-center gap-1 px-1.5 py-0.5 rounded bg-amber-500/20 border border-amber-400/50",children:[e.jsx(Ye,{size:12,className:"text-amber-400"}),e.jsx("span",{className:"text-amber-300 text-[10px] font-bold uppercase",children:"Best"})]})]})});$e.displayName="StreakDisplay";$e.propTypes={streak:R.number.isRequired,isNewRecord:R.bool.isRequired,bestStreak:R.number};const He=t.memo(({streak:l,onContinue:d})=>(console.log("[SuccessOverlay] Rendering with streak:",l),e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0,0,0,0.85)"},children:e.jsx("div",{style:{background:"linear-gradient(135deg, rgb(15, 23, 42) 0%, rgb(30, 41, 59) 100%)",borderRadius:"16px",padding:"24px",maxWidth:"380px",width:"100%",margin:"0 16px",border:"2px solid rgba(34, 197, 94, 0.5)",boxShadow:"0 0 60px rgba(34, 197, 94, 0.4)"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{width:"64px",height:"64px",margin:"0 auto 16px",borderRadius:"50%",background:"linear-gradient(135deg, rgb(34, 197, 94), rgb(16, 185, 129))",display:"flex",alignItems:"center",justifyContent:"center",animation:"pulse 1s ease-in-out infinite"},children:e.jsx(Wt,{size:32,style:{color:"white"}})}),e.jsx("h2",{style:{fontSize:"28px",fontWeight:"900",color:"#4ade80",marginBottom:"8px",textShadow:"0 0 20px rgba(34, 197, 94, 0.5)"},children:"CORRECT!"}),e.jsxs("p",{style:{color:"#94a3b8",marginBottom:"16px"},children:["Streak: ",e.jsx("span",{style:{color:"white",fontWeight:"700",fontSize:"24px"},children:l})]}),e.jsxs("button",{onClick:()=>{console.log("[SuccessOverlay] Continue clicked"),d()},style:{width:"100%",padding:"16px",borderRadius:"12px",fontWeight:"900",letterSpacing:"0.05em",fontSize:"18px",background:"linear-gradient(90deg, rgb(34, 197, 94), rgb(16, 185, 129))",color:"white",border:"none",cursor:"pointer",boxShadow:"0 0 30px rgba(34, 197, 94, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:[e.jsx(Xt,{size:24}),"NEXT PUZZLE"]}),e.jsx("p",{style:{fontSize:"12px",color:"#64748b",marginTop:"12px"},children:"Press quickly! Timer starts immediately"})]})})})));He.displayName="SuccessOverlay";He.propTypes={streak:R.number.isRequired,onContinue:R.func.isRequired};const qe=t.memo(({streak:l,bestStreak:d,onPlayAgain:s,onMenu:f})=>(console.log("[GameOverOverlay] Rendering with:",{streak:l,bestStreak:d}),e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0,0,0,0.9)"},children:e.jsx("div",{style:{background:"linear-gradient(135deg, rgb(15, 23, 42) 0%, rgb(30, 41, 59) 100%)",borderRadius:"16px",padding:"24px",maxWidth:"380px",width:"100%",margin:"0 16px",border:"2px solid rgba(239, 68, 68, 0.5)",boxShadow:"0 0 60px rgba(239, 68, 68, 0.4)"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{width:"64px",height:"64px",margin:"0 auto 16px",borderRadius:"50%",background:"linear-gradient(135deg, rgb(239, 68, 68), rgb(234, 88, 12))",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(ct,{size:32,style:{color:"white"}})}),e.jsx("h2",{style:{fontSize:"28px",fontWeight:"900",color:"#f87171",marginBottom:"16px",textShadow:"0 0 20px rgba(239, 68, 68, 0.5)"},children:"TIME'S UP!"}),e.jsxs("div",{style:{background:"rgba(30, 41, 59, 0.8)",borderRadius:"12px",padding:"16px",marginBottom:"24px",border:"1px solid rgba(71, 85, 105, 0.5)"},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"16px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"11px",color:"#64748b",textTransform:"uppercase",letterSpacing:"0.05em",marginBottom:"4px"},children:"Final Streak"}),e.jsx("div",{style:{fontSize:"32px",fontWeight:"900",color:"white"},children:l})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"11px",color:"#64748b",textTransform:"uppercase",letterSpacing:"0.05em",marginBottom:"4px"},children:"Best Ever"}),e.jsx("div",{style:{fontSize:"32px",fontWeight:"900",color:l>=d&&l>0?"#fbbf24":"#94a3b8"},children:Math.max(l,d)})]})]}),l>=d&&l>0&&e.jsxs("div",{style:{marginTop:"12px",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",color:"#fbbf24"},children:[e.jsx(Ye,{size:18}),e.jsx("span",{style:{fontWeight:"700",fontSize:"14px"},children:"New Personal Best!"})]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"12px"},children:[e.jsxs("button",{onClick:()=>{console.log("[GameOverOverlay] Play Again clicked"),s()},style:{width:"100%",padding:"16px",borderRadius:"12px",fontWeight:"900",letterSpacing:"0.05em",fontSize:"18px",background:"linear-gradient(90deg, rgb(239, 68, 68), rgb(234, 88, 12))",color:"white",border:"none",cursor:"pointer",boxShadow:"0 0 30px rgba(239, 68, 68, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:[e.jsx(We,{size:22}),"PLAY AGAIN"]}),e.jsxs("button",{onClick:()=>{console.log("[GameOverOverlay] Menu clicked"),f()},style:{width:"100%",padding:"12px",borderRadius:"12px",fontWeight:"700",color:"#cbd5e1",background:"rgb(30, 41, 59)",border:"1px solid rgb(71, 85, 105)",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:[e.jsx(at,{size:18}),"Back to Menu"]})]})]})})})));qe.displayName="GameOverOverlay";qe.propTypes={streak:R.number.isRequired,bestStreak:R.number.isRequired,onPlayAgain:R.func.isRequired,onMenu:R.func.isRequired};const Fe=t.memo(({message:l,onRetry:d,onMenu:s})=>e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center",style:{backgroundColor:"rgba(0,0,0,0.85)"},children:e.jsx("div",{className:"bg-slate-900 rounded-2xl p-6 max-w-sm w-full mx-4 border border-amber-500/50 shadow-[0_0_60px_rgba(251,191,36,0.3)]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center",children:e.jsx(We,{size:32,className:"text-white"})}),e.jsx("h2",{className:"text-2xl font-black text-amber-400 mb-2",children:"OOPS!"}),e.jsx("p",{className:"text-slate-400 mb-6",children:l||"Something went wrong. Please try again."}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:d,className:"w-full py-4 rounded-xl font-black tracking-wider text-lg bg-gradient-to-r from-amber-500 to-orange-600 text-white hover:from-amber-400 hover:to-orange-500 transition-all shadow-[0_0_30px_rgba(251,191,36,0.5)] active:scale-[0.98]",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(We,{size:22}),"TRY AGAIN"]})}),e.jsx("button",{onClick:s,className:"w-full py-3 rounded-xl font-bold text-slate-300 bg-slate-800 hover:bg-slate-700 transition-all border border-slate-600",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(at,{size:18}),"Back to Menu"]})})]})]})})}));Fe.displayName="ErrorOverlay";Fe.propTypes={message:R.string,onRetry:R.func.isRequired,onMenu:R.func.isRequired};const Jt=({onMenu:l,isOfflineMode:d=!1})=>{const[s,f]=t.useState(i.LOADING),[w,S]=t.useState(""),[u,te]=t.useState(0),[D,Ue]=t.useState(()=>Kt(Be.BEST_STREAK,0)),[dt,Ve]=t.useState(0),[q,Re]=t.useState(we),[j,je]=t.useState(lt),[ue,Ce]=t.useState(it),[ne,Ee]=t.useState([]),[F,ut]=t.useState(null),[y,U]=t.useState(null),[h,Pe]=t.useState(0),[b,Ne]=t.useState(!1),[a,N]=t.useState(null),[ft,Ze]=t.useState(null),[mt,Ke]=t.useState(!1),[C,fe]=t.useState(!1),[O,me]=t.useState(null),[pt,pe]=t.useState({x:0,y:0}),[xt,ke]=t.useState({x:0,y:0}),[gt,Te]=t.useState(!1),[ze,Ae]=t.useState(null),[ht,xe]=t.useState({row:0,col:0}),ge=t.useRef(null),re=t.useRef(Date.now()),I=t.useRef(!1),se=t.useRef(0),V=t.useRef(!0),he=t.useRef(new Set),_=t.useRef(null),Y=t.useRef(null);t.useRef({x:0,y:0});const W=t.useRef(!1),oe=Math.max(D,dt),bt=u>0&&u>=oe,{needsScroll:be}=It(650),yt=t.useMemo(()=>a?ie(j,a.row,a.col,a.coords):!1,[a,j]),X=t.useCallback((n,r)=>{const o=setTimeout(()=>{he.current.delete(o),V.current&&n()},r);return he.current.add(o),o},[]),k=t.useCallback(()=>{ge.current&&(clearInterval(ge.current),ge.current=null)},[]),$=t.useRef({row:0,col:0}),Ie=t.useRef({move:null,end:null,cancel:null}),Je=t.useRef(null),Me=t.useRef(null),Z=t.useRef(!1),H=t.useRef(null),ye=t.useRef(null),Ge=t.useCallback((n,r,o,c,m,T)=>{if(!c||!n)return{row:0,col:0};const p=ee(n,m,T);if(!p||p.length===0)return{row:0,col:0};const x=Math.min(...p.map(([G])=>G)),E=Math.max(...p.map(([G])=>G)),v=Math.min(...p.map(([,G])=>G)),z=Math.max(...p.map(([,G])=>G)),M=E-x+1,A=z-v+1,ae=(r-c.left)/c.width,P=(o-c.top)/c.height,ce=Math.floor(ae*M)+x,Q=Math.floor(P*A)+v;let tt={row:0,col:0},nt=1/0;for(const[G,rt]of p){const st=Math.abs(G-ce)+Math.abs(rt-Q);st<nt&&(nt=st,tt={row:rt,col:G})}return tt},[]),Qe=t.useCallback((n,r)=>{if(!Y.current)return null;const{left:o,top:c,width:m,height:T}=Y.current,p=m/L,x=T/L,v=typeof window<"u"&&window.innerWidth<640?40:20,z=n-o,M=r-v-c,A=Math.floor(z/p),ae=Math.floor(M/x),P=A-$.current.col,ce=ae-$.current.row,Q=4;return ce>=-Q&&ce<L+Q&&P>=-Q&&P<L+Q?{row:ce,col:P}:null},[]),K=t.useCallback(()=>{const{move:n,end:r,cancel:o}=Ie.current;n&&window.removeEventListener("touchmove",n,{capture:!0}),r&&window.removeEventListener("touchend",r,{capture:!0}),o&&window.removeEventListener("touchcancel",o,{capture:!0}),Ie.current={move:null,end:null,cancel:null}},[]),ve=t.useCallback(()=>{K();const n=c=>{c.touches&&c.touches[0]&&(Je.current?.(c.touches[0].clientX,c.touches[0].clientY),c.cancelable&&c.preventDefault())},r=()=>{Me.current?.()},o=()=>{Me.current?.()};Ie.current={move:n,end:r,cancel:o},window.addEventListener("touchmove",n,{passive:!1,capture:!0}),window.addEventListener("touchend",r,{capture:!0}),window.addEventListener("touchcancel",o,{capture:!0})},[K]),le=t.useCallback((n,r)=>{if(!C&&!Z.current||!O&&!H.current)return;const o=O||H.current;pe({x:n,y:r});const c=Qe(n,r);if(c&&o){const m=ee(o,h,b),T=Math.min(...m.map(([P])=>P)),p=Math.max(...m.map(([P])=>P)),x=Math.min(...m.map(([,P])=>P)),E=Math.max(...m.map(([,P])=>P)),v=Math.floor((p+T)/2),z=Math.floor((E+x)/2),M=c.row-z,A=c.col-v;ye.current={row:M,col:A},Ae({row:M,col:A});const ae=ie(j,M,A,m);Te(ae)}else ye.current=null,Ae(null),Te(!1)},[C,O,h,b,j,Qe]),J=t.useCallback(()=>{if(!C&&!Z.current)return;K();const n=O||H.current,r=ye.current||ze;if(r&&n){const o=ee(n,h,b);N({piece:n,row:r.row,col:r.col,coords:o})}Z.current=!1,H.current=null,ye.current=null,fe(!1),me(null),Te(!1),Ae(null),W.current=!1,$.current={row:0,col:0},document.body.style.overflow="",document.body.style.touchAction=""},[C,O,ze,h,b,K]);Je.current=le,Me.current=J;const vt=t.useCallback(n=>{if(s!==i.PLAYING)return{};if(ne.includes(n))return{};let r=null;return{onMouseDown:p=>{if(p.button!==0||W.current)return;W.current=!0,Z.current=!0,H.current=n;const{clientX:x,clientY:E}=p,v=p.currentTarget?.getBoundingClientRect()||null,z=Ge(n,x,E,v,h,b);$.current=z,xe(z);const M=v?x-(v.left+v.width/2):0,A=v?E-(v.top+v.height/2):0;_.current&&(Y.current=_.current.getBoundingClientRect()),fe(!0),me(n),U(n),N(null),pe({x,y:E}),ke({x:M,y:A}),document.body.style.overflow="hidden",document.body.style.touchAction="none",g.playPieceSelect()},onTouchStart:p=>{if(W.current)return;const x=p.touches?.[0];if(!x)return;W.current=!0,Z.current=!0,H.current=n,ve(),r=p.currentTarget?.getBoundingClientRect()||null;const E=Ge(n,x.clientX,x.clientY,r,h,b);$.current=E,xe(E);const v=r?x.clientX-(r.left+r.width/2):0,z=r?x.clientY-(r.top+r.height/2):0;_.current&&(Y.current=_.current.getBoundingClientRect()),fe(!0),me(n),U(n),N(null),pe({x:x.clientX,y:x.clientY}),ke({x:v,y:z}),document.body.style.overflow="hidden",document.body.style.touchAction="none",g.playPieceSelect()},onTouchMove:()=>{},onTouchEnd:()=>{}}},[s,ne,h,b,Ge,ve]),wt=t.useCallback((n,r,o,c)=>{if(!W.current&&s===i.PLAYING&&!(!a||a.piece!==n)){if(W.current=!0,Z.current=!0,H.current=n,ve(),_.current&&(Y.current=_.current.getBoundingClientRect()),a&&Y.current){const{left:m,top:T,width:p,height:x}=Y.current,E=p/L,v=x/L,z=Math.floor((r-m)/E),A={row:Math.floor((o-T)/v)-a.row,col:z-a.col};$.current=A,xe(A)}else $.current={row:0,col:0},xe({row:0,col:0});fe(!0),me(n),pe({x:r,y:o}),ke({x:0,y:0}),g.playPieceSelect(),document.body.style.overflow="hidden",document.body.style.touchAction="none"}},[s,a,ve]);t.useEffect(()=>{if(!C)return;const n=o=>{le(o.clientX,o.clientY)},r=()=>{J()};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",r),()=>{window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",r)}},[C,le,J]),t.useEffect(()=>{if(!C)return;const n=c=>{c.touches?.[0]&&(le(c.touches[0].clientX,c.touches[0].clientY),c.cancelable&&c.preventDefault())},r=()=>J(),o=()=>J();return window.addEventListener("touchmove",n,{passive:!1}),window.addEventListener("touchend",r),window.addEventListener("touchcancel",o),()=>{window.removeEventListener("touchmove",n),window.removeEventListener("touchend",r),window.removeEventListener("touchcancel",o)}},[C,le,J]),t.useEffect(()=>()=>{K(),document.body.style.overflow="",document.body.style.touchAction=""},[K]),t.useEffect(()=>{if(d)return;(async()=>{try{const r=await de.getStats();r?.speed_best_streak&&V.current&&(Ve(r.speed_best_streak),r.speed_best_streak>D&&(Ue(r.speed_best_streak),ot(Be.BEST_STREAK,r.speed_best_streak)))}catch(r){console.error("[SpeedPuzzle] Failed to load db stats:",r)}})()},[d,D]),t.useEffect(()=>(V.current=!0,()=>{V.current=!1,k(),he.current.forEach(n=>clearTimeout(n)),he.current.clear(),document.body.style.overflow="",document.body.style.touchAction=""}),[k]),t.useEffect(()=>{console.log("[SpeedPuzzle] gameState changed to:",s)},[s]);const et=t.useCallback(()=>{if(console.log("[SpeedPuzzle] triggerGameOver called, current handled status:",I.current),I.current){console.log("[SpeedPuzzle] Game over already handled, skipping");return}console.log("[SpeedPuzzle] Setting game over state"),I.current=!0,k();try{g.playLose()}catch(n){console.error("[SpeedPuzzle] Error playing game over sound:",n)}f(n=>(console.log("[SpeedPuzzle] Changing state from",n,"to",i.GAMEOVER),i.GAMEOVER))},[k]),B=t.useCallback(async()=>{f(i.LOADING),S(""),I.current=!1,k();try{const n=await Mt();if(!V.current)return;if(n?.boardState?.length===64){const{newBoard:r,newBoardPieces:o}=_e(n.boardState);je(r),Ce(o),Ee(n.usedPieces||[]),ut(n),U(null),Pe(0),Ne(!1),N(null),se.current=0,Re(we),re.current=Date.now(),X(()=>{f(i.PLAYING)},Ft)}else throw new Error("Invalid puzzle data received")}catch(n){if(console.error("[SpeedPuzzle] Failed to load puzzle:",n),!V.current)return;se.current++,se.current<Ut?X(B,Vt):(se.current=0,S(n.message||"Failed to generate puzzle. Please try again."),f(i.ERROR))}},[k,X]);t.useEffect(()=>{if(s===i.PLAYING)return re.current=Date.now(),I.current=!1,ge.current=setInterval(()=>{const n=Date.now(),r=(n-re.current)/1e3;re.current=n,Re(o=>Math.max(0,o-r))},$t),k},[s,k]),t.useEffect(()=>{q<=1&&console.log("[SpeedPuzzle] Timer low:",{timeLeft:q,gameState:s,gameOverHandled:I.current,shouldTrigger:s===i.PLAYING&&q<=0&&!I.current}),s===i.PLAYING&&q<=0&&!I.current&&(console.log("[SpeedPuzzle] *** TIMER EXPIRED - TRIGGERING GAME OVER ***"),et())},[q,s,et]),t.useEffect(()=>{console.log("[SpeedPuzzle] >>> gameState is now:",s),s===i.GAMEOVER&&console.log("[SpeedPuzzle] >>> GAMEOVER STATE ACTIVE - overlay should be visible")},[s]),t.useEffect(()=>{B()},[]);const St=t.useCallback(n=>{s===i.PLAYING&&(g.playClickSound("select"),U(n),Pe(0),Ne(!1),N(null))},[s]),Rt=t.useCallback(()=>{if(!y||s!==i.PLAYING)return;g.playClickSound("rotate");const n=(h+1)%4;if(Pe(n),a){const r=ee(y,n,b);N(o=>({...o,coords:r}))}},[y,s,h,b,a]),jt=t.useCallback(()=>{if(!y||s!==i.PLAYING)return;g.playClickSound("flip");const n=!b;if(Ne(n),a){const r=ee(y,h,n);N(o=>({...o,coords:r}))}},[y,s,h,b,a]),Ct=t.useCallback((n,r)=>{if(!y||s!==i.PLAYING)return;const o=ee(y,h,b);N({row:n,col:r,coords:o,piece:y}),ie(j,n,r,o)?g.playClickSound("place"):g.playInvalid()},[y,s,h,b,j]),Et=t.useCallback(n=>{if(console.log("[SpeedPuzzle] movePendingPiece called:",n,{pendingMove:a,gameState:s}),!a||s!==i.PLAYING){console.log("[SpeedPuzzle] movePendingPiece blocked:",{hasPending:!!a,gameState:s});return}const[r,o]=Zt[n],c=a.row+r,m=a.col+o;console.log("[SpeedPuzzle] Moving piece:",{from:{row:a.row,col:a.col},to:{row:c,col:m}}),ie(j,c,m,a.coords)?g.playClickSound("move"):g.playInvalid(),N(p=>({...p,row:c,col:m}))},[a,s,j]),Pt=t.useCallback(()=>{s===i.PLAYING&&(g.playClickSound("cancel"),N(null))},[s]),Nt=t.useCallback(()=>{if(!a||!y||s!==i.PLAYING)return;if(!ie(j,a.row,a.col,a.coords)){g.playInvalid();return}k(),I.current=!0,Ze({...a,pieceType:y,rot:h,flip:b});const n=j.map(c=>[...c]),r=ue.map(c=>[...c]);for(const[c,m]of a.coords){const T=a.row+m,p=a.col+c;n[T][p]=1,r[T][p]=y}const o=[...ne,y];je(n),Ce(r),Ee(o),U(null),N(null),g.playPiecePlace(),X(()=>Ze(null),Ht),X(()=>{if(Gt(n,o))console.log("[SpeedPuzzle] Wrong move - AI can still play, showing feedback"),g.playInvalid(),Ke(!0),X(()=>{Ke(!1)},1500),je(F?_e(F.boardState).newBoard:j),Ce(F?_e(F.boardState).newBoardPieces:ue),Ee(F?.usedPieces||[]),U(null),N(null),I.current=!1,Re(we),re.current=Date.now(),f(i.PLAYING);else{g.playWin();const m=u+1;te(m),d||de.recordSpeedPuzzleComplete(),m>oe&&(Ue(m),Ve(m),ot(Be.BEST_STREAK,m),d||de.updateSpeedBestStreak(m)),f(i.SUCCESS)}},qt)},[a,y,s,j,ue,ne,u,oe,d,h,b,k,X,F]),kt=t.useCallback(()=>{g.playButtonClick(),B()},[B]),Tt=t.useCallback(()=>{g.playButtonClick(),!d&&u>0&&de.recordSpeedSessionComplete(u),te(0),B()},[d,u,B]),Le=t.useCallback(()=>{g.playButtonClick(),k(),!d&&u>0&&de.recordSpeedSessionComplete(u),l()},[d,u,l,k]),zt=t.useCallback(()=>{g.playButtonClick(),se.current=0,B()},[B]),At=be?{overflowY:"auto",overflowX:"hidden",WebkitOverflowScrolling:"touch",touchAction:"pan-y",scrollBehavior:"smooth",overscrollBehavior:"contain"}:{};return e.jsxs("div",{className:be?"min-h-screen bg-slate-950":"h-screen bg-slate-950 overflow-hidden",style:At,children:[e.jsx("div",{className:"fixed inset-0 opacity-30 pointer-events-none",style:{backgroundImage:`linear-gradient(${Se.gridColor} 1px, transparent 1px), linear-gradient(90deg, ${Se.gridColor} 1px, transparent 1px)`,backgroundSize:"40px 40px"}}),e.jsx("div",{className:`fixed top-10 left-20 w-80 h-80 ${Se.glow1} rounded-full blur-3xl pointer-events-none`}),e.jsx("div",{className:`fixed bottom-20 right-10 w-72 h-72 ${Se.glow2} rounded-full blur-3xl pointer-events-none`}),e.jsxs("div",{className:`relative ${be?"pb-safe min-h-full":"h-full"} flex flex-col items-center px-2 py-2`,children:[e.jsx("div",{className:"w-full max-w-md mb-2 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:Le,className:"px-3 py-1.5 bg-slate-800 text-cyan-300 rounded-lg text-xs sm:text-sm border border-cyan-500/30 hover:bg-slate-700 shadow-[0_0_10px_rgba(34,211,238,0.3)]",children:"MENU"}),e.jsx("div",{className:"text-center flex-1",children:e.jsx("div",{className:"speed-subtitle font-black tracking-[0.2em] text-base sm:text-lg",children:"⚡ SPEED MODE ⚡"})}),e.jsx("div",{className:"w-[52px]"})]})}),s===i.PLAYING&&e.jsxs("div",{className:"flex items-center justify-center gap-3 mb-2 flex-shrink-0",children:[e.jsx(Xe,{timeLeft:q,maxTime:we}),e.jsx($e,{streak:u,isNewRecord:bt,bestStreak:oe})]}),s===i.LOADING&&e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-12 h-12 border-4 border-red-500/30 border-t-red-500 rounded-full animate-spin mx-auto mb-4"}),e.jsx("div",{className:"text-slate-400 text-sm",children:"Generating puzzle..."})]})}),(s===i.PLAYING||s===i.SUCCESS)&&e.jsxs(e.Fragment,{children:[C&&O&&e.jsx(Lt,{isDragging:C,piece:O,rotation:h,flipped:b,position:pt,offset:xt,isValidDrop:gt,cellOffset:ht}),e.jsxs("div",{className:"w-full max-w-md flex-shrink-0 flex justify-center relative",children:[e.jsx("div",{className:"w-[min(85vw,85vh,340px)] aspect-square",children:e.jsx(Ot,{ref:_,board:j,boardPieces:ue,currentPlayer:1,pendingMove:a,playerAnimatingMove:ft,onCellClick:Ct,selectedPiece:y,rotation:h,flipped:b,gameOver:s!==i.PLAYING,onPendingPieceDragStart:wt,customColors:{1:"bg-gradient-to-br from-cyan-400 to-blue-500",2:"bg-gradient-to-br from-rose-400 to-pink-500"},isDragging:C,dragPreviewCell:ze,draggedPiece:O,dragRotation:h,dragFlipped:b})}),mt&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none z-20",children:e.jsx("div",{className:"bg-red-900/90 text-white px-6 py-4 rounded-xl border-2 border-red-500 shadow-[0_0_30px_rgba(239,68,68,0.5)] animate-pulse",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-black mb-1",children:"WRONG MOVE!"}),e.jsx("div",{className:"text-sm text-red-200",children:"AI can still play - try again"})]})})})]}),s===i.PLAYING&&a&&!C&&e.jsx("div",{className:"flex justify-center mt-3 flex-shrink-0",children:e.jsx(Dt,{onMove:Et})}),s===i.PLAYING&&e.jsx("div",{className:"mt-2 w-full max-w-md flex-shrink-0",children:e.jsx(Bt,{selectedPiece:y,pendingMove:a,canConfirm:yt,gameOver:!1,gameMode:"puzzle",currentPlayer:1,isGeneratingPuzzle:!1,onRotate:Rt,onFlip:jt,onConfirm:Nt,onCancel:Pt,hideResetButtons:!0})}),e.jsx("div",{className:"mt-2 w-full max-w-md flex-shrink-0",children:e.jsx(_t,{usedPieces:ne,currentPlayer:1,isPlayerTurn:!0,selectedPiece:y,onSelectPiece:St,rotation:h,flipped:b,pendingMove:a,gameOver:s!==i.PLAYING,createDragHandlers:vt,isDragging:C,draggedPiece:O})}),be&&e.jsx("div",{className:"h-12 flex-shrink-0"})]})]}),s===i.SUCCESS&&e.jsx(He,{streak:u,onContinue:kt}),s===i.GAMEOVER&&e.jsx(qe,{streak:u,bestStreak:oe,onPlayAgain:Tt,onMenu:Le}),s===i.ERROR&&e.jsx(Fe,{message:w,onRetry:zt,onMenu:Le}),e.jsx("style",{children:`
        .pb-safe {
          padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .speed-subtitle {
          color: #fff;
          text-shadow:
            0 0 5px #fff,
            0 0 10px #fff,
            0 0 20px #ef4444,
            0 0 40px #ef4444,
            0 0 60px #f97316;
          animation: speed-pulse 2s ease-in-out infinite;
        }
        
        @keyframes speed-pulse {
          0%, 100% { filter: brightness(1); }
          50% { filter: brightness(1.2); }
        }
        
        @keyframes timer-shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-2px); }
          75% { transform: translateX(2px); }
        }
        .animate-timer-shake {
          animation: timer-shake 0.1s ease-in-out infinite;
        }
        
        @keyframes timer-critical {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.02); }
        }
        .animate-timer-critical {
          animation: timer-critical 0.3s ease-in-out infinite;
        }
        
        @keyframes timer-pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.8; }
        }
        .animate-timer-pulse {
          animation: timer-pulse 0.5s ease-in-out infinite;
        }
      `})]})};Jt.propTypes={onMenu:R.func.isRequired,isOfflineMode:R.bool};export{Jt as default};
