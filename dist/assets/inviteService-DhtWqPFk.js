import{$ as g,a7 as b}from"./index-8HZmLUul.js";const k="sb-oyeibyrednwlolmsjlwk-auth-token",d="https://oyeibyrednwlolmsjlwk.supabase.co",y="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95ZWlieXJlZG53bG9sbXNqbHdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMzMyNzQsImV4cCI6MjA4MDgwOTI3NH0.GNMI2HOyOn_YHPPgsrkinB5FipLedqo0bTN9PKRQJMY",f=()=>{try{const p=JSON.parse(localStorage.getItem(k)||"null");return!p?.access_token||!y?null:{Authorization:`Bearer ${p.access_token}`,apikey:y,"Content-Type":"application/json"}}catch{return null}},I=async(p,a,r={})=>{const e=f();if(!e)return{data:null,error:{message:"Not authenticated"}};try{const n=await fetch(`${d}/rest/v1/${p}`,{method:"POST",headers:r.returning?{...e,Prefer:"return=representation"}:e,body:JSON.stringify(a)});if(!n.ok){const t=await n.text();console.error("[inviteService] dbInsert failed:",n.status,t);let s="Insert failed";try{const i=JSON.parse(t);s=i.message||i.error||t}catch{s=t||`HTTP ${n.status}`}return{data:null,error:{message:s}}}if(r.returning){const t=await n.json();return{data:r.single?t[0]:t,error:null}}return{data:!0,error:null}}catch(n){return console.error("[inviteService] dbInsert exception:",n),{data:null,error:{message:n.message}}}},_=async(p,a,r={},e={})=>{const n=f();if(!n)return{data:null,error:"Not authenticated"};let t=`${d}/rest/v1/${p}?`;r.eq&&Object.entries(r.eq).forEach(([s,i])=>{t+=`${s}=eq.${i}&`}),r.in&&Object.entries(r.in).forEach(([s,i])=>{t+=`${s}=in.(${i.join(",")})&`});try{const s=await fetch(t,{method:"PATCH",headers:e.returning?{...n,Prefer:"return=representation"}:{...n,Prefer:"return=minimal"},body:JSON.stringify(a)});if(!s.ok){const i=await s.text();return console.error("[dbUpdate] Error:",s.status,i),{data:null,error:"Update failed"}}if(e.returning){const i=await s.json();return{data:e.single?i[0]:i,error:null}}return{data:!0,error:null}}catch(s){return{data:null,error:s.message}}};class j{constructor(){this.unsubscribeHandler=null}async searchUsers(a,r,e=10){if(!g()||!a||a.length<2)return{data:[],error:null};try{const n=f();if(!n)return{data:[],error:{message:"Not authenticated"}};const t=a.trim().toLowerCase(),s=t.includes("@");let i;s?i=`email.ilike.*${t}*,username.ilike.*${t}*`:i=`username.ilike.*${t}*,display_name.ilike.*${t}*,email.ilike.*${t}*`;const l=`${d}/rest/v1/profiles?select=id,username,display_name,rating,games_played,games_won&or=(${encodeURIComponent(i)})&id=neq.${r}&order=rating.desc&limit=${e}`,u=await fetch(l,{headers:n});return u.ok?{data:await u.json()||[],error:null}:(console.error("[InviteService] Search failed:",u.statusText),{data:[],error:{message:u.statusText}})}catch(n){return console.error("searchUsers exception:",n),{data:[],error:{message:n.message}}}}async sendInvite(a,r,e="random",n=!1){if(!g())return{data:null,error:{message:"Not configured"}};try{const t=f();if(!t)return{data:null,error:{message:"Not authenticated"}};const s=`${d}/rest/v1/rematch_requests?select=id&or=(and(from_user_id.eq.${a},to_user_id.eq.${r}),and(from_user_id.eq.${r},to_user_id.eq.${a}))&status=eq.pending&limit=1`,i=await fetch(s,{headers:t});if(i.ok&&(await i.json())?.length>0)return{data:null,error:{message:'There is already a pending rematch request with this player. Check "Rematch Requests" in the Online Menu.',code:"REMATCH_EXISTS"}};const l=`${d}/rest/v1/game_invites?select=id,status,from_user_id,order_preference&or=(and(from_user_id.eq.${a},to_user_id.eq.${r}),and(from_user_id.eq.${r},to_user_id.eq.${a}))&status=eq.pending&limit=1`,u=await fetch(l,{headers:t});if(u.ok){const m=await u.json();if(m?.length>0){const c=m[0];if(c.from_user_id===r){let v="random";return e==="me"?v="invitee":e==="opponent"&&(v="inviter"),await this.acceptInvite(c.id,a,v)}return{data:null,error:{message:'You already have a pending challenge to this player. Check your "Pending Invites" or wait for them to respond.',code:"INVITE_EXISTS"}}}}const o={from_user_id:a,to_user_id:r,status:"pending",expires_at:new Date(Date.now()+24*60*60*1e3).toISOString()};return e&&e!=="random"&&(o.order_preference=e),n&&(o.is_rematch=!0),await I("game_invites",o,{returning:!0,single:!0})}catch(t){return console.error("sendInvite exception:",t),{data:null,error:{message:t.message}}}}async getReceivedInvites(a){if(!g())return{data:[],error:null};try{const r=f();if(!r)return{data:[],error:null};const e=`${d}/rest/v1/game_invites?select=*&to_user_id=eq.${a}&status=eq.pending&expires_at=gt.${new Date().toISOString()}&order=created_at.desc`,n=await fetch(e,{headers:r});if(!n.ok)return{data:[],error:null};const t=await n.json();if(!t?.length)return{data:[],error:null};const s=t.map(c=>c.from_user_id),i=`${d}/rest/v1/profiles?id=in.(${s.join(",")})&select=id,username,display_name,rating`,l=await fetch(i,{headers:r}),u=l.ok?await l.json():[],o={};return u.forEach(c=>{o[c.id]=c}),{data:t.map(c=>({...c,from_user:o[c.from_user_id]})),error:null}}catch(r){return console.error("getReceivedInvites exception:",r),{data:[],error:{message:r.message}}}}async getSentInvites(a){if(!g())return{data:[],error:null};try{const r=f();if(!r)return{data:[],error:null};const e=`${d}/rest/v1/game_invites?select=*&from_user_id=eq.${a}&status=eq.pending&expires_at=gt.${new Date().toISOString()}&order=created_at.desc`,n=await fetch(e,{headers:r});if(!n.ok)return{data:[],error:null};const t=await n.json();if(!t?.length)return{data:[],error:null};const s=t.map(c=>c.to_user_id),i=`${d}/rest/v1/profiles?id=in.(${s.join(",")})&select=id,username,display_name,rating`,l=await fetch(i,{headers:r}),u=l.ok?await l.json():[],o={};return u.forEach(c=>{o[c.id]=c}),{data:t.map(c=>({...c,to_user:o[c.to_user_id]})),error:null}}catch(r){return console.error("getSentInvites exception:",r),{data:[],error:{message:r.message}}}}async acceptInvite(a,r,e="random"){if(!g())return{data:null,error:{message:"Not configured"}};try{const n=f();if(!n)return{data:null,error:{message:"Not authenticated"}};const t=`${d}/rest/v1/game_invites?id=eq.${a}&select=*`,s=await fetch(t,{headers:{...n,Accept:"application/vnd.pgrst.object+json"}});if(!s.ok)return{data:null,error:{message:"Invite not found"}};const i=await s.json();if(!i)return{data:null,error:{message:"Invite not found"}};if(i.status!=="pending")return{data:null,error:{message:"Invite already processed"}};if(i.to_user_id!==r&&i.from_user_id!==r)return{data:null,error:{message:"Not authorized"}};const l=Array(8).fill(null).map(()=>Array(8).fill(0));let u;const o=i.order_preference||"random";let m=e;o==="me"&&e==="invitee"||o==="opponent"&&e==="inviter"?m="random":o==="me"?m="inviter":o==="opponent"&&(m="invitee"),u=m==="inviter"?1:m==="invitee"?2:Math.random()<.5?1:2;const c=await fetch(`${d}/rest/v1/games`,{method:"POST",headers:{...n,Prefer:"return=representation"},body:JSON.stringify({player1_id:i.from_user_id,player2_id:i.to_user_id,board:l,board_pieces:{},used_pieces:[],current_player:u,status:"active"})});if(!c.ok)return console.error("Failed to create game"),{data:null,error:{message:"Failed to create game"}};const h=(await c.json())[0];await _("game_invites",{status:"accepted",game_id:h.id},{eq:{id:a}});const $=`${d}/rest/v1/games?id=eq.${h.id}&select=*`,w=await fetch($,{headers:{...n,Accept:"application/vnd.pgrst.object+json"}}),S=w.ok?await w.json():h;return{data:{invite:{...i,status:"accepted",game_id:h.id},game:S},error:null}}catch(n){return console.error("acceptInvite exception:",n),{data:null,error:{message:n.message}}}}async declineInvite(a,r){if(!g())return{error:{message:"Not configured"}};try{const e=f();if(!e)return{error:{message:"Not authenticated"}};const n=`${d}/rest/v1/game_invites?id=eq.${a}&select=to_user_id`,t=await fetch(n,{headers:{...e,Accept:"application/vnd.pgrst.object+json"}});return t.ok&&(await t.json())?.to_user_id!==r?{error:{message:"Not authorized"}}:await _("game_invites",{status:"declined"},{eq:{id:a}})}catch(e){return console.error("declineInvite exception:",e),{error:{message:e.message}}}}async cancelInvite(a,r){if(!g())return{error:{message:"Not configured"}};try{const e=f();if(!e)return{error:{message:"Not authenticated"}};const n=`${d}/rest/v1/game_invites?id=eq.${a}&select=from_user_id,status`,t=await fetch(n,{headers:e});if(!t.ok)return{error:{message:"Failed to fetch invite"}};const s=await t.json();if(!s||s.length===0)return{error:{message:"Invite not found"}};const i=s[0];if(i.from_user_id!==r)return{error:{message:"Not authorized to cancel this invite"}};if(i.status!=="pending")return{error:{message:"Invite is no longer pending"}};const l=await _("game_invites",{status:"cancelled"},{eq:{id:a}});return l.error?{error:{message:l.error}}:{data:!0,error:null}}catch(e){return console.error("cancelInvite exception:",e),{error:{message:e.message}}}}async createInviteLink(a,r=""){if(!g())return{data:null,error:{message:"Not configured"}};try{const e={from_user_id:a,to_email:r.trim()||`friend_${Date.now()}`,status:"pending",expires_at:new Date(Date.now()+6048e5).toISOString()},{data:n,error:t}=await I("email_invites",e,{returning:!0,single:!0});if(t)return console.error("[InviteService] Error creating invite link:",t),{data:null,error:t};if(!n?.invite_code)return console.error("[InviteService] Invite created but no invite_code returned!",n),{data:null,error:{message:"Invite code not generated"}};const i=`${window.location.origin}/?invite=${n.invite_code}`;return{data:{...n,inviteLink:i,recipientName:r.trim()||"Friend"},error:null}}catch(e){return console.error("createInviteLink exception:",e),{data:null,error:{message:e.message}}}}async getInviteLinks(a){if(!g())return{data:[],error:null};try{const r=f();if(!r)return{data:[],error:null};const e=new Date().toISOString(),n=`${d}/rest/v1/email_invites?select=*&from_user_id=eq.${a}&status=in.(pending,sent)&expires_at=gt.${e}&game_id=is.null&order=created_at.desc`,t={...r,"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache"},s=await fetch(n,{headers:t});if(!s.ok){const o=await s.text();return console.error("[InviteService] getInviteLinks error:",s.status,o),{data:[],error:null}}const i=await s.json(),l=window.location.origin;return{data:(i||[]).map(o=>({...o,inviteLink:`${l}/?invite=${o.invite_code}`,recipientName:o.to_email?.startsWith("friend_")?"Friend":o.to_email})),error:null}}catch(r){return console.error("getInviteLinks exception:",r),{data:[],error:{message:r.message}}}}async cancelInviteLink(a,r){if(!g())return{error:{message:"Not configured"}};try{const e=f();if(!e)return{error:{message:"Not authenticated"}};const n=`${d}/rest/v1/email_invites?id=eq.${a}&from_user_id=eq.${r}`,t=await fetch(n,{method:"DELETE",headers:{...e,Prefer:"return=minimal"}});if(!t.ok){const s=await t.text();if(console.error("[InviteService] Delete failed:",t.status,s),!(await fetch(n,{method:"PATCH",headers:{...e,Prefer:"return=minimal"},body:JSON.stringify({status:"cancelled"})})).ok)return console.error("[InviteService] Fallback PATCH also failed"),{error:{message:"Failed to delete invite link"}}}return{error:null}}catch(e){return console.error("cancelInviteLink exception:",e),{error:{message:e.message}}}}async markInviteLinkShared(a,r){if(!g())return{error:{message:"Not configured"}};try{return await _("email_invites",{status:"sent",sent_at:new Date().toISOString()},{eq:{id:a}})}catch(e){return console.error("markInviteLinkShared exception:",e),{error:{message:e.message}}}}async getInviteByCode(a){if(!g())return{data:null,error:{message:"Not configured"}};try{const r={apikey:y,"Content-Type":"application/json"},e=f();e&&(r.Authorization=e.Authorization);const n=`${d}/rest/v1/email_invites?invite_code=eq.${a}&status=in.(pending,sent)&expires_at=gt.${new Date().toISOString()}&select=*`,t=await fetch(n,{headers:{...r,Accept:"application/vnd.pgrst.object+json"}});if(!t.ok)return{data:null,error:{message:"Invite not found"}};const s=await t.json();if(!s||!s.id)return{data:null,error:{message:"Invite not found"}};const i=`${d}/rest/v1/profiles?id=eq.${s.from_user_id}&select=id,username,display_name,rating`,l=await fetch(i,{headers:{...r,Accept:"application/vnd.pgrst.object+json"}});let u=null;return l.ok&&(u=await l.json()),{data:{...s,from_user:u},error:null}}catch(r){return console.error("getInviteByCode exception:",r),{data:null,error:{message:r.message}}}}async acceptInviteByCode(a,r){if(!g())return{data:null,error:{message:"Not configured"}};try{const e=f();if(!e)return{data:null,error:{message:"Not authenticated"}};const{data:n,error:t}=await this.getInviteByCode(a);if(t||!n)return{data:null,error:{message:"Invite not found or expired"}};if(n.from_user_id===r)return{data:null,error:{message:"Cannot accept your own invite"}};if(n.status!=="pending"&&n.status!=="sent")return{data:null,error:{message:"Invite already used"}};const s=Array(8).fill(null).map(()=>Array(8).fill(0)),l=await fetch(`${d}/rest/v1/games`,{method:"POST",headers:{...e,Prefer:"return=representation"},body:JSON.stringify({player1_id:n.from_user_id,player2_id:r,board:s,board_pieces:{},used_pieces:[],current_player:2,status:"active"})});if(!l.ok){const v=await l.text();return console.error("[InviteService] Failed to create game:",v),{data:null,error:{message:"Failed to create game"}}}const o=(await l.json())[0],m=`${d}/rest/v1/email_invites?id=eq.${n.id}`,c=await fetch(m,{method:"PATCH",headers:{...e,Prefer:"return=representation"},body:JSON.stringify({status:"accepted",game_id:o.id,accepted_by:r,accepted_at:new Date().toISOString()})});if(!c.ok)console.error("[InviteService] Failed to update invite status:",c.status);else{const v=await c.json()}return{data:{success:!0,game_id:o.id,game:o,invite:{...n,status:"accepted",game_id:o.id}},error:null}}catch(e){return console.error("acceptInviteByCode exception:",e),{data:null,error:{message:e.message}}}}subscribeToInvites(a,r,e){const n=t=>{if(!t)return;const s=t.to_user_id===a,i=t.from_user_id===a;!s&&!i||(s&&t.status==="pending"?r?.(t):e?.(t))};return this.unsubscribeHandler=b.on("gameInvite",n),{unsubscribe:()=>{this.unsubscribeHandler&&(this.unsubscribeHandler(),this.unsubscribeHandler=null)}}}unsubscribeFromInvites(a){a?.unsubscribe&&a.unsubscribe()}}const x=new j;export{x as default,x as inviteService};
