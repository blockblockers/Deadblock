import{m as Z,$ as x,ai as g,a7 as E,ap as D,am as K,al as Q,aj as Y,r as m,j as e,a4 as w,X as A,U as B,B as y,s as N,a2 as M,an as I,p as ee,W as R,G as te}from"./index-8HZmLUul.js";import{A as se}from"./alert-triangle-CdR1lECF.js";const T=Z("Radio",[["path",{d:"M4.9 19.1C1 15.2 1 8.8 4.9 4.9",key:"1vaf9d"}],["path",{d:"M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5",key:"u1ii0m"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5",key:"1j5fej"}],["path",{d:"M19.1 4.9C23 8.8 23 15.1 19.1 19",key:"10b0cb"}]]);let _=null;const b={async getSpectatableGames(s=10){if(!x())return{data:[],error:null};try{const{data:t,error:a}=await Y("get_spectatable_games",{limit_count:s});return a?.code==="42883"||a?.message?.includes("does not exist")?{data:[],error:null}:{data:t||[],error:a}}catch(t){return console.error("Error in getSpectatableGames:",t),{data:[],error:null}}},async joinAsSpectator(s,t){return x()?await Q("game_spectators",{game_id:s,user_id:t},{returning:!0,single:!0}):{error:{message:"Not configured"}}},async leaveSpectating(s,t){if(!x())return{error:null};const{error:a}=await K("game_spectators",{eq:{game_id:s,user_id:t}});return this.stopSpectatorPolling(),{error:a}},async getSpectators(s){if(!x())return{data:[],error:null};const{data:t,error:a}=await g("game_spectators",{select:"id,joined_at,user_id",eq:{game_id:s},order:"joined_at.asc"});if(a||!t?.length)return{data:[],error:a};const n=t.map(l=>l.user_id),{data:c}=await g("profiles",{select:"id,username,avatar_url",in:{id:n}}),d={};return c?.forEach(l=>{d[l.id]=l}),{data:t.map(l=>({id:l.id,joined_at:l.joined_at,user:d[l.user_id]})),error:null}},async getSpectatorCount(s){if(!x())return{count:0,error:null};const{count:t,error:a}=await D("game_spectators",{eq:{game_id:s}});return{count:t||0,error:a}},subscribeToSpectators(s,t){return x()?(console.log("[SpectatorService] Starting spectator count polling (10s interval)"),this.getSpectators(s).then(({data:a})=>{t(a||[])}),_=setInterval(async()=>{const{data:a}=await this.getSpectators(s);t(a||[])},1e4),{unsubscribe:()=>this.stopSpectatorPolling()}):{unsubscribe:()=>{}}},stopSpectatorPolling(){_&&(clearInterval(_),_=null)},subscribeToGame(s,t,a){if(!x())return{unsubscribe:()=>{}};console.log("[SpectatorService] Subscribing to game via RealtimeManager"),E.connectGame(s);const n=E.on("gameUpdate",c=>{console.log("[SpectatorService] Game update received:",c?.id),t(c)});return{unsubscribe:()=>{n(),E.disconnectGame()}}},unsubscribe(s){s?.unsubscribe&&s.unsubscribe(),this.stopSpectatorPolling()},async getGameForSpectating(s){if(!x())return{data:null,error:{message:"Not configured"}};let{data:t,error:a}=await g("games",{select:"id,status,board,board_pieces,used_pieces,current_player,winner_id,created_at,updated_at,allow_spectators,player1_id,player2_id",eq:{id:s},single:!0});if(a||!t)return{data:null,error:a||{message:"Game not found"}};if(!t.allow_spectators&&t.status==="active")return{data:null,error:{message:"This game does not allow spectators"}};const{data:n}=await g("profiles",{select:"id,username,avatar_url,rating",in:{id:[t.player1_id,t.player2_id]}}),c={};return n?.forEach(d=>{c[d.id]=d}),{data:{...t,player1:c[t.player1_id],player2:c[t.player2_id]},error:null}},async isSpectating(s,t){if(!x())return!1;const{data:a}=await g("game_spectators",{select:"id",eq:{game_id:s,user_id:t},single:!0});return!!a},async getFriendGames(s){if(!x()||!s.length)return{data:[],error:null};const{data:t,error:a}=await g("games",{select:"id,status,current_player,allow_spectators,created_at,player1_id,player2_id",in:{player1_id:s},eq:{status:"active",allow_spectators:!0}});if(a||!t?.length)return{data:[],error:a};const n=[...new Set(t.flatMap(l=>[l.player1_id,l.player2_id]))],{data:c}=await g("profiles",{select:"id,username,avatar_url,rating",in:{id:n}}),d={};return c?.forEach(l=>{d[l.id]=l}),{data:t.map(l=>({...l,player1:d[l.player1_id],player2:d[l.player2_id]})),error:null}}},ae=({gameId:s,userId:t,onClose:a,friendGames:n=[],onSwitchGame:c,currentGameIndex:d=0})=>{const[r,l]=m.useState(null),[h,j]=m.useState([]),[u,f]=m.useState(!0),[z,G]=m.useState(null),[L,q]=m.useState(Array(y).fill(null).map(()=>Array(y).fill(null))),[O,U]=m.useState({}),S=m.useRef(null),k=m.useRef(null);m.useEffect(()=>(V(),()=>{$()}),[s,t]);const V=async()=>{f(!0),t&&await b.joinAsSpectator(s,t);const{data:i,error:o}=await b.getGameForSpectating(s);if(o){G(o.message),f(!1);return}l(i),P(i);const{data:C}=await b.getSpectators(s);j(C||[]),S.current=b.subscribeToGame(s,p=>{l(p),P(p),N.playClickSound("soft")},p=>{console.error("Spectator subscription error:",p)}),k.current=b.subscribeToSpectators(s,p=>{j(p)}),f(!1)},$=async()=>{t&&await b.leaveSpectating(s,t),S.current&&b.unsubscribe(S.current),k.current&&b.unsubscribe(k.current)},P=i=>{if(!i)return;let o=i.board;Array.isArray(o)&&o.length===y?o=o.map(C=>C.map(p=>p===0?null:p)):o=Array(y).fill(null).map(()=>Array(y).fill(null)),q(o),U(i.board_pieces||{})},F=()=>{if(n.length<=1)return;const i=d>0?d-1:n.length-1,o=n[i];o?.id&&c&&(N.playButtonClick(),c(o.id,i))},W=()=>{if(n.length<=1)return;const i=d<n.length-1?d+1:0,o=n[i];o?.id&&c&&(N.playButtonClick(),c(o.id,i))};if(u)return e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-slate-900 to-slate-950 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-amber-400 border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{className:"text-slate-400",children:"Joining as spectator..."})]})});if(z)return e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-slate-900 to-slate-950 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-slate-800 rounded-xl p-6 text-center max-w-sm",children:[e.jsx(se,{className:"mx-auto text-amber-400 mb-3",size:48}),e.jsx("h2",{className:"text-white text-xl font-bold mb-2",children:"Unable to Watch"}),e.jsx("p",{className:"text-slate-400 mb-4",children:z}),e.jsx("button",{onClick:a,className:"px-6 py-2 bg-amber-500 text-white rounded-lg font-medium hover:bg-amber-400",children:"Go Back"})]})});const v=r?.status==="completed",H=r?.current_player===1?r?.player1?.username:r?.player2?.username,J=M.getRatingTier(r?.player1?.rating||r?.player1?.elo_rating||1200),X=M.getRatingTier(r?.player2?.rating||r?.player2?.elo_rating||1200);return e.jsxs("div",{className:"min-h-screen bg-gradient-to-b from-slate-900 to-slate-950 flex flex-col",children:[e.jsx("div",{className:"bg-slate-900 border-b border-amber-500/30 p-4",children:e.jsxs("div",{className:"flex items-center justify-between max-w-md mx-auto",children:[e.jsx("button",{onClick:a,className:"p-2 text-slate-400 hover:text-white transition-colors",children:e.jsx(A,{size:24})}),e.jsxs("div",{className:"flex items-center gap-2 text-amber-400",children:[e.jsx(w,{size:20}),e.jsx("span",{className:"font-medium",children:"Spectating"}),!v&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-red-400 animate-pulse",children:[e.jsx(T,{size:12})," LIVE"]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-slate-500 text-sm",children:[e.jsx(B,{size:16}),e.jsx("span",{children:h.length})]})]})}),n.length>1&&e.jsxs("div",{className:"bg-slate-800/50 border-b border-slate-700/50 py-2 px-4",children:[e.jsxs("div",{className:"max-w-md mx-auto flex items-center justify-center gap-4",children:[e.jsx("button",{onClick:F,className:"p-2 rounded-full bg-slate-700/50 hover:bg-slate-600 text-slate-400 hover:text-white transition-all",children:e.jsx(I,{size:20})}),e.jsx("div",{className:"flex items-center gap-2",children:n.map((i,o)=>e.jsx("button",{onClick:()=>{i.id!==s&&c&&(N.playButtonClick(),c(i.id,o))},className:`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all ${i.id===s?"bg-amber-500 text-white shadow-lg shadow-amber-500/30":"bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white"}`,title:`Game ${o+1}`,children:o+1},i.id))}),e.jsx("button",{onClick:W,className:"p-2 rounded-full bg-slate-700/50 hover:bg-slate-600 text-slate-400 hover:text-white transition-all",children:e.jsx(ee,{size:20})})]}),e.jsxs("p",{className:"text-center text-slate-500 text-xs mt-1",children:["Game ",d+1," of ",n.length]})]}),e.jsx("div",{className:"bg-slate-800/50 p-3",children:e.jsxs("div",{className:"max-w-md mx-auto flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(R,{tier:J.name,size:24}),r?.current_player===1&&!v&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-3 h-3 bg-cyan-400 rounded-full animate-pulse"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-cyan-400 font-medium text-sm",children:r?.player1?.username||"Player 1"}),e.jsx("div",{className:"text-slate-500 text-xs",children:r?.player1?.rating||r?.player1?.elo_rating||1200})]})]}),e.jsx("div",{className:"text-slate-600 font-bold",children:"VS"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-pink-400 font-medium text-sm text-right",children:r?.player2?.username||"Player 2"}),e.jsx("div",{className:"text-slate-500 text-xs text-right",children:r?.player2?.rating||r?.player2?.elo_rating||1200})]}),e.jsxs("div",{className:"relative",children:[e.jsx(R,{tier:X.name,size:24}),r?.current_player===2&&!v&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-3 h-3 bg-pink-400 rounded-full animate-pulse"})]})]})]})}),e.jsx("div",{className:"bg-slate-800/50 p-2 text-center",children:v?e.jsxs("span",{className:"text-amber-400 font-medium",children:["Game Over - ",r?.winner_id===r?.player1?.id?r?.player1?.username:r?.player2?.username," wins!"]}):e.jsxs("span",{className:"text-slate-300",children:[e.jsx("span",{className:r?.current_player===1?"text-cyan-400":"text-pink-400",children:H}),"'s turn"]})}),e.jsx("div",{className:"flex-1 flex items-center justify-center p-4 overflow-hidden",children:e.jsx("div",{className:"w-full max-w-md",children:e.jsx(te,{board:L,boardPieces:O,selectedPiece:null,pendingMove:null,currentPlayer:r?.current_player||1,onCellClick:()=>{},disabled:!0})})}),h.length>0&&e.jsx("div",{className:"bg-slate-900 border-t border-slate-800 p-3",children:e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 mb-2",children:[e.jsx(w,{size:12})," Spectators:"]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[h.slice(0,10).map(i=>e.jsx("span",{className:"px-2 py-1 bg-slate-800 rounded-full text-xs text-slate-400",children:i.user?.username||"Anonymous"},i.id)),h.length>10&&e.jsxs("span",{className:"px-2 py-1 bg-slate-800 rounded-full text-xs text-slate-500",children:["+",h.length-10," more"]})]})]})}),e.jsx("div",{className:"bg-slate-900 border-t border-amber-500/30 p-4",children:e.jsx("button",{onClick:a,className:"w-full max-w-md mx-auto block py-3 bg-slate-800 text-slate-300 rounded-lg font-medium hover:bg-slate-700",children:"Stop Watching"})})]})},re=({userId:s,onSpectate:t,onClose:a})=>{const[n,c]=m.useState([]),[d,r]=m.useState(!0),[l,h]=m.useState(null);m.useEffect(()=>{j();const u=setInterval(j,1e4);return()=>clearInterval(u)},[]);const j=async()=>{try{const{data:u,error:f}=await b.getSpectatableGames(20);if(f)throw f;c(u||[]),h(null)}catch(u){console.error("Error loading spectatable games:",u),h("Unable to load live games. Please try again.")}finally{r(!1)}};return e.jsx("div",{className:"fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-slate-900 rounded-xl max-w-md w-full max-h-[80vh] overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-slate-700 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-400",children:[e.jsx(w,{size:20}),e.jsx("span",{className:"font-bold",children:"Live Games"})]}),e.jsx("button",{onClick:a,className:"text-slate-400 hover:text-white",children:e.jsx(A,{size:24})})]}),e.jsx("div",{className:"p-4 overflow-y-auto",style:{maxHeight:"calc(80vh - 80px)",WebkitOverflowScrolling:"touch",overscrollBehavior:"contain"},children:d?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-amber-400 border-t-transparent rounded-full mx-auto mb-2"}),e.jsx("p",{className:"text-slate-400 text-sm",children:"Finding games..."})]}):n.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(w,{className:"mx-auto text-slate-600 mb-2",size:40}),e.jsx("p",{className:"text-slate-400",children:"No live games right now"}),e.jsx("p",{className:"text-slate-500 text-sm mt-1",children:"Check back later!"})]}):e.jsx("div",{className:"space-y-3",children:n.map(u=>e.jsxs("button",{onClick:()=>t(u.game_id),className:"w-full p-4 bg-slate-800/50 rounded-lg border border-slate-700 hover:border-amber-500/30 transition-all text-left",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-cyan-400 font-medium",children:u.player1_username}),e.jsxs("span",{className:"text-slate-500 text-xs",children:["(",u.player1_rating,")"]})]}),e.jsx("span",{className:"text-slate-600",children:"vs"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-slate-500 text-xs",children:["(",u.player2_rating,")"]}),e.jsx("span",{className:"text-pink-400 font-medium",children:u.player2_username})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(B,{size:12})," ",u.spectator_count," watching"]}),e.jsxs("span",{className:"flex items-center gap-1 text-red-400",children:[e.jsx(T,{size:12})," LIVE"]})]})]},u.game_id))})})]})})},ie=Object.freeze(Object.defineProperty({__proto__:null,SpectatableGamesList:re,default:ae},Symbol.toStringTag,{value:"Module"}));export{re as S,ie as a,b as s};
