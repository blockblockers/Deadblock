import{r as w,a6 as r,j as ne,$ as ae}from"./index-8HZmLUul.js";const I={CACHED_USER_ID:"deadblock_cached_user_id",CACHED_PROFILE:"deadblock_cached_profile",CACHED_TIMESTAMP:"deadblock_cached_timestamp"},ie=7*24*60*60*1e3,U=i=>{try{return localStorage.getItem(i)}catch(h){return console.warn("[AuthContext] localStorage read error:",h),null}},v=(i,h)=>{try{localStorage.setItem(i,h)}catch(f){console.warn("[AuthContext] localStorage write error:",f)}},H=i=>{try{localStorage.removeItem(i)}catch(h){console.warn("[AuthContext] localStorage remove error:",h)}},N=()=>{try{const i=U(I.CACHED_USER_ID),h=U(I.CACHED_PROFILE),f=U(I.CACHED_TIMESTAMP);if(!i||!h)return null;const S=JSON.parse(h),R=parseInt(f,10)||0,p=Date.now()-R;return console.log("[AuthContext] Loaded cached profile:",{username:S?.username,userId:i,ageMinutes:Math.round(p/6e4)}),{userId:i,profile:S,isExpired:p>ie}}catch(i){return console.warn("[AuthContext] Error loading cached profile:",i),null}},F=(i,h)=>{try{if(!i||!h)return;v(I.CACHED_USER_ID,i),v(I.CACHED_PROFILE,JSON.stringify(h)),v(I.CACHED_TIMESTAMP,Date.now().toString()),console.log("[AuthContext] Saved profile to cache:",{username:h.username})}catch(f){console.warn("[AuthContext] Error saving profile to cache:",f)}},T=()=>{H(I.CACHED_USER_ID),H(I.CACHED_PROFILE),H(I.CACHED_TIMESTAMP),console.log("[AuthContext] Cleared cached profile")},M=w.createContext({user:null,profile:null,loading:!0,sessionReady:!1,isAuthenticated:!1,isOnlineEnabled:!1,isOAuthCallback:!1,isNewUser:!1,signUp:async()=>{},signIn:async()=>{},signInWithGoogle:async()=>{},signOut:async()=>{},updateProfile:async()=>{},clearOAuthCallback:()=>{},clearNewUser:()=>{},refreshProfile:async()=>{}}),ce=({children:i})=>{const h=N(),[f,S]=w.useState(null),[R,p]=w.useState(h?.profile||null),[$,y]=w.useState(!h?.profile),[B,O]=w.useState(!1),[K,x]=w.useState(!1),[W,D]=w.useState(!1),L=w.useRef(!1),j=ae(),A=w.useCallback(async(e,t=0)=>{if(!r)return console.log("[AuthContext] fetchProfile: supabase not configured"),null;if(!e)return console.log("[AuthContext] fetchProfile: no userId provided"),null;const o=3;console.log(`[AuthContext] fetchProfile: fetching for ${e}, attempt ${t+1}`);try{const{data:m,error:d}=await r.from("profiles").select("*").eq("id",e).single();return d?(console.error("[AuthContext] fetchProfile error:",d),d.code==="PGRST116"&&(console.log("[AuthContext] Profile not found, may need to create one"),t<o)?(console.log(`[AuthContext] Profile retry ${t+1}/${o}...`),await new Promise(c=>setTimeout(c,500*(t+1))),A(e,t+1)):null):(console.log("[AuthContext] fetchProfile success:",{username:m?.username,id:m?.id}),p(m),F(e,m),m)}catch(m){return console.error("[AuthContext] fetchProfile exception:",m),t<o?(await new Promise(d=>setTimeout(d,500*(t+1))),A(e,t+1)):null}},[]);w.useEffect(()=>{if(!r){y(!1);return}const e=window.location.href,t=window.location.hash,o=window.location.search,m=t.includes("access_token=")||o.includes("access_token="),d=o.includes("code="),c=m||d;e.includes("/auth/callback")&&!c&&(console.log("Cleaning up empty OAuth callback URL"),window.history.replaceState({},document.title,"/")),c&&(console.log("OAuth callback detected with auth data, processing..."),x(!0));const C=async()=>{if(c){console.log("=== OAuth Callback Processing Started ===");try{const s=new Promise((u,n)=>setTimeout(()=>n(new Error("OAuth timeout")),15e3));console.log("OAuth: Getting session from Supabase...");const l=r.auth.getSession(),{data:a,error:g}=await Promise.race([l,s.then(()=>({data:null,error:{message:"Timeout"}}))]);if(console.log("OAuth: Session response:",{hasData:!!a,hasSession:!!a?.session,hasUser:!!a?.session?.user,error:g?.message}),g)console.error("OAuth: Error getting session:",g),x(!1);else if(a?.session){console.log("OAuth: Session established successfully",{userId:a.session.user?.id,email:a.session.user?.email}),S(a.session.user);try{console.log("OAuth: Fetching profile...");const u=await A(a.session.user.id);if(console.log("OAuth: Profile result:",{hasProfile:!!u}),u?.created_at){const n=new Date(u.created_at),E=(new Date-n)/1e3;E<60&&(console.log("OAuth: New user detected (profile created",E,"seconds ago)"),D(!0))}}catch(u){console.error("OAuth: Profile fetch failed:",u)}console.log("OAuth: Callback processed successfully, waiting for App.jsx to handle redirect")}else console.log("OAuth: No session in response"),x(!1);console.log("OAuth: Cleaning up URL"),window.history.replaceState({},document.title,"/")}catch(s){console.error("OAuth: Callback error:",s),x(!1),window.history.replaceState({},document.title,"/")}console.log("=== OAuth Callback Processing Finished ===")}};(async()=>{console.log("=== Auth Init Started ===");const s=N();s?.profile&&!L.current&&(console.log("Auth init: Using cached profile for instant display:",s.profile.username),p(s.profile),y(!1));let l=!1;const a=c?2e4:s?.profile?4e3:1e4;console.log("Auth init: Setting timeout for",a,"ms (OAuth:",c,", hasCached:",!!s?.profile,")");const g=setTimeout(async()=>{if(!l){console.log("Auth init: TIMEOUT - completing with current state");const k=!!(await r.auth.getSession().catch(()=>null))?.data?.session?.user;if(!k&&s?.profile&&s?.userId){console.log("Auth init: Timeout with valid cache and NO real session - trusting cached auth state"),S({id:s.userId,email:s.profile.email||"cached@user"});const E=s.userId;setTimeout(async()=>{const P=N();if(!P?.userId||P.userId!==E){console.log("Auth init: Background refresh skipped - user state changed");return}console.log("Auth init: Background refresh triggered after timeout");try{const _=await A(E);_?console.log("Auth init: Background refresh successful:",_.username):console.log("Auth init: Background refresh returned no data")}catch(_){console.error("Auth init: Background refresh error:",_)}},500)}else k&&console.log("Auth init: Timeout but real session exists - not overwriting user");O(!0),y(!1)}},a),u=()=>{l=!0,clearTimeout(g)};try{console.log("Auth init: Handling OAuth callback (if any)..."),await C(),console.log("Auth init: OAuth callback handling complete"),console.log("Auth init: Getting current session...");const{data:{session:n},error:k}=await r.auth.getSession();if(k){console.error("Auth init: Error getting session:",k),u(),O(!0),y(!1);return}if(console.log("Auth init: Session result",{hasSession:!!n,userId:n?.user?.id,email:n?.user?.email}),S(n?.user??null),O(!0),console.log("Auth init: User state set, isAuthenticated will be:",!!n?.user,", sessionReady: true"),s?.profile&&n?.user&&s.userId!==n.user.id&&(console.log("Auth init: Cached profile is for different user, clearing"),T(),p(null)),!n?.user){s?.profile&&(console.log("Auth init: No session but have cached profile, clearing"),T(),p(null)),u(),O(!0),y(!1);return}console.log("Auth init: Fetching fresh profile for",n.user.id),L.current=!0;const E=await A(n.user.id);if(console.log("Auth init: Profile fetch result",{hasProfile:!!E,username:E?.username}),!E&&!s?.profile){console.log("Auth init: Profile not found and no cache, starting retry...");for(let P=0;P<3;P++){await new Promise(se=>setTimeout(se,500*(P+1)));const _=await A(n.user.id);if(console.log(`Auth init: Retry ${P+1} result:`,{hasProfile:!!_}),_)break}}u(),console.log("Auth init: Setting loading to false"),y(!1),console.log("=== Auth Init Complete ===")}catch(n){console.error("Auth init: Error:",n),u(),y(!1)}})();const{data:{subscription:b}}=r.auth.onAuthStateChange(async(s,l)=>{if(console.log("[AuthContext] Auth event:",s,l?.user?.email),S(l?.user??null),l?.user&&(console.log("[AuthContext] Setting sessionReady=true from",s),O(!0)),s==="SIGNED_IN"&&l?.user)console.log("[AuthContext] SIGNED_IN - fetching profile"),await A(l.user.id),(window.location.pathname.includes("/auth/callback")||window.location.hash||window.location.search)&&window.history.replaceState({},document.title,"/");else if(s==="TOKEN_REFRESHED"&&l?.user){console.log("[AuthContext] TOKEN_REFRESHED - fetching profile for",l.user.id);const a=await A(l.user.id);if(console.log("[AuthContext] TOKEN_REFRESHED - profile fetch result:",{hasProfile:!!a,username:a?.username}),!a){console.log("[AuthContext] TOKEN_REFRESHED - profile not found, retrying...");for(let g=0;g<3;g++){await new Promise(n=>setTimeout(n,1e3*(g+1)));const u=await A(l.user.id);if(console.log(`[AuthContext] TOKEN_REFRESHED - retry ${g+1}:`,{hasProfile:!!u}),u)break}}}else if(s==="INITIAL_SESSION"&&l?.user){console.log("[AuthContext] INITIAL_SESSION - fetching profile for",l.user.id);const a=await A(l.user.id);if(console.log("[AuthContext] INITIAL_SESSION - profile fetch result:",{hasProfile:!!a,username:a?.username}),!a){console.log("[AuthContext] INITIAL_SESSION - profile not found, retrying...");for(let g=0;g<3;g++){await new Promise(n=>setTimeout(n,1e3*(g+1)));const u=await A(l.user.id);if(console.log(`[AuthContext] INITIAL_SESSION - retry ${g+1}:`,{hasProfile:!!u}),u)break}}}else s==="INITIAL_SESSION"&&!l?(console.log("[AuthContext] INITIAL_SESSION - no session, user not logged in"),O(!0),N()?.profile&&(console.log("[AuthContext] Clearing stale cached profile"),T(),p(null))):s==="SIGNED_OUT"&&(S(null),p(null),x(!1),O(!0),T(),localStorage.removeItem("deadblock_entry_auth_passed"),console.log("[AuthContext] SIGNED_OUT - cleared user, profile, and cache"))});return()=>b.unsubscribe()},[A]);const q=async(e,t,o)=>{if(!r)return{error:{message:"Online features not configured"}};if(!o||o.length<3||o.length>20)return{error:{message:"Username must be 3-20 characters"}};if(!/^[a-zA-Z0-9_]+$/.test(o))return{error:{message:"Username can only contain letters, numbers, and underscores"}};const{data:m}=await r.from("profiles").select("username").eq("username",o).single();if(m)return{error:{message:"Username already taken"}};const{data:d,error:c}=await r.auth.signUp({email:e,password:t,options:{data:{username:o,display_name:o},emailRedirectTo:void 0}});if(!c&&d?.user){await new Promise(b=>setTimeout(b,500));const{data:C}=await r.from("profiles").select("id").eq("id",d.user.id).single();if(!C){console.log("Profile not created by trigger, creating manually...");const{error:b}=await r.from("profiles").insert({id:d.user.id,username:o,display_name:o});b&&console.error("Failed to create profile manually:",b)}const G=!d.session;return D(!0),{data:d,error:null,needsEmailConfirmation:G,isNewUser:!0}}if(c){let C=c.message;return c.message.includes("database error")?C="Account created but profile setup failed. Please try signing in.":c.message.includes("already registered")?C="An account with this email already exists":c.message.includes("invalid email")?C="Please enter a valid email address":c.message.includes("weak password")&&(C="Password is too weak. Use at least 6 characters"),{data:d,error:{...c,message:C}}}return{data:d,error:c}},J=async(e,t)=>{if(!r)return{error:{message:"Online features not configured"}};const{data:o,error:m}=await r.auth.signInWithPassword({email:e,password:t});return{data:o,error:m}},Y=async()=>{if(!r)return{error:{message:"Online features not configured"}};console.log("[AuthContext] Starting Google OAuth with redirect to:",`${window.location.origin}/auth/callback`);try{const{data:e,error:t}=await r.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,skipBrowserRedirect:!1}});return console.log("[AuthContext] Google OAuth result:",{data:e,error:t}),t?(console.error("[AuthContext] Google OAuth error:",t),{data:e,error:t}):(e?.url&&(console.log("[AuthContext] OAuth URL received, redirecting to:",e.url),window.location.href=e.url),{data:e,error:t})}catch(e){return console.error("[AuthContext] Google OAuth exception:",e),{data:null,error:{message:e.message||"Failed to start Google Sign In"}}}},z=async()=>{if(r){console.log("[AuthContext] signOut: Starting sign out process"),S(null),p(null),O(!1),T(),localStorage.removeItem("deadblock_entry_auth_passed"),localStorage.removeItem("deadblock_pending_invite_code");try{const{error:e}=await r.auth.signOut();e?console.error("[AuthContext] signOut: Supabase error:",e):console.log("[AuthContext] signOut: Supabase sign out successful")}catch(e){console.error("[AuthContext] signOut: Exception:",e)}return console.log("[AuthContext] signOut: Complete - cleared user, profile, and cache"),{error:null}}},X=async e=>{if(!r)return{error:{message:"Online features not configured"}};const{data:t,error:o}=await r.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/auth/callback?type=recovery`});return{data:t,error:o}},Z=async e=>{if(!r)return{error:{message:"Online features not configured"}};const{data:t,error:o}=await r.auth.signInWithOtp({email:e,options:{emailRedirectTo:`${window.location.origin}/auth/callback?type=magiclink`}});return{data:t,error:o}},Q=async e=>{if(!r||!f)return{error:{message:"Not authenticated"}};const{data:t,error:o}=await r.auth.updateUser({email:e});return{data:t,error:o}},V=async e=>{if(!r||!f)return{error:{message:"Not authenticated"}};const{data:t,error:o}=await r.auth.updateUser({password:e});return{data:t,error:o}},ee=async e=>{if(!r||!f)return{error:{message:"Not authenticated"}};const{data:t,error:o}=await r.from("profiles").update(e).eq("id",f.id).select().single();return!o&&t&&(p(t),F(f.id,t)),{data:t,error:o}},te=async e=>{if(!r)return{available:!1,error:{message:"Not configured"}};if(R?.username?.toLowerCase()===e.toLowerCase())return{available:!0,error:null};const{data:t,error:o}=await r.from("profiles").select("id").ilike("username",e).single();return o?.code==="PGRST116"?{available:!0,error:null}:o?{available:!1,error:o}:{available:!1,error:null}},oe=()=>{x(!1)},re=()=>{D(!1)};return ne.jsx(M.Provider,{value:{user:f,profile:R,loading:$,sessionReady:B,isAuthenticated:!!f,isOnlineEnabled:j,isOAuthCallback:K,isNewUser:W,signUp:q,signIn:J,signInWithGoogle:Y,signInWithMagicLink:Z,signOut:z,resetPassword:X,updateEmail:Q,updatePassword:V,updateProfile:ee,checkUsernameAvailable:te,refreshProfile:async()=>f?await A(f.id):null,clearOAuthCallback:oe,clearNewUser:re},children:i})},ue=()=>{const i=w.useContext(M);if(!i)throw new Error("useAuth must be used within an AuthProvider");return i};export{ce as AuthProvider,M as default,ue as useAuth};
