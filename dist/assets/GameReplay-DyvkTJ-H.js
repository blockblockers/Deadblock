import{m as R,$ as b,ai as y,ap as S,al as F,r as p,B as _,j as e,X as T,T as M,G as B,s as C}from"./index-8HZmLUul.js";import{C as A}from"./clock-DH6CZMwC.js";import{S as L}from"./share-2-R-aqbu5s.js";import{S as W,P as U,a as K}from"./skip-forward-CzNewA36.js";import{P as O}from"./play-CKcjBX8x.js";const V=R("FastForward",[["polygon",{points:"13 19 22 12 13 5 13 19",key:"587y9g"}],["polygon",{points:"2 19 11 12 2 5 2 19",key:"3pweh0"}]]),X=R("Rewind",[["polygon",{points:"11 19 2 12 11 5 11 19",key:"14yba5"}],["polygon",{points:"22 19 13 12 22 5 22 19",key:"1pi1cj"}]]),j={async recordMove(l,a,t){return b()?await F("game_moves",{game_id:l,player_id:a,move_number:t.moveNumber,piece_type:t.pieceType,row:t.row,col:t.col,rotation:t.rotation||0,flipped:t.flipped||!1,board_state:t.boardState,time_taken_seconds:t.timeTaken},{returning:!0,single:!0}):{error:null}},async getGameMoves(l){if(!b())return{data:[],error:null};const{data:a,error:t}=await y("game_moves",{select:"id,move_number,piece_type,row,col,rotation,flipped,board_state,time_taken_seconds,created_at,player_id",eq:{game_id:l},order:"move_number.asc"});if(t||!a?.length)return{data:[],error:t};const c=[...new Set(a.map(s=>s.player_id))],{data:r}=await y("profiles",{select:"id,username",in:{id:c}}),u={};return r?.forEach(s=>{u[s.id]=s}),{data:a.map(s=>({...s,player:u[s.player_id]})),error:null}},async getReplaySummary(l){if(!b())return{data:null,error:null};const{data:a,error:t}=await y("online_games",{select:"id,status,winner_id,created_at,updated_at,player1_id,player2_id",eq:{id:l},single:!0});if(t||!a)return{data:null,error:t};const{data:c}=await y("profiles",{select:"id,username,avatar_url,elo_rating",in:{id:[a.player1_id,a.player2_id]}}),r={};c?.forEach(x=>{r[x.id]=x});const{count:u}=await S("game_moves",{eq:{game_id:l}}),o=new Date(a.created_at),s=new Date(a.updated_at),n=Math.floor((s-o)/1e3);return{data:{...a,player1:r[a.player1_id],player2:r[a.player2_id],moveCount:u||0,durationSeconds:n,durationFormatted:Z(n)},error:null}},async getUserReplays(l,a=20){if(!b())return{data:[],error:null};const{data:t,error:c}=await y("online_games",{select:"id,status,winner_id,created_at,updated_at,player1_id,player2_id",or:`player1_id.eq.${l},player2_id.eq.${l}`,eq:{status:"completed"},order:"updated_at.desc",limit:a});if(c||!t?.length)return{data:[],error:c};const r=[...new Set(t.flatMap(n=>[n.player1_id,n.player2_id]))],{data:u}=await y("profiles",{select:"id,username,avatar_url",in:{id:r}}),o={};return u?.forEach(n=>{o[n.id]=n}),{data:await Promise.all(t.map(async n=>{const{count:x}=await S("game_moves",{eq:{game_id:n.id}});return{...n,player1:o[n.player1_id],player2:o[n.player2_id],moveCount:x||0,isWin:n.winner_id===l,opponent:n.player1_id===l?o[n.player2_id]:o[n.player1_id]}})),error:null}},async getFeaturedReplays(l=10){if(!b())return{data:[],error:null};const{data:a,error:t}=await y("online_games",{select:"id,winner_id,created_at,updated_at,player1_id,player2_id",eq:{status:"completed"},order:"updated_at.desc",limit:50});if(t||!a?.length)return{data:[],error:t};const c=[...new Set(a.flatMap(s=>[s.player1_id,s.player2_id]))],{data:r}=await y("profiles",{select:"id,username,avatar_url,elo_rating",in:{id:c}}),u={};return r?.forEach(s=>{u[s.id]=s}),{data:a.map(s=>({...s,player1:u[s.player1_id],player2:u[s.player2_id],combinedRating:(u[s.player1_id]?.elo_rating||1200)+(u[s.player2_id]?.elo_rating||1200)})).sort((s,n)=>n.combinedRating-s.combinedRating).slice(0,l),error:null}},getReplayLink(l){return`${window.location.origin}/?replay=${l}`},async getKeyMoments(l){if(!b())return{data:[],error:null};const{data:a,error:t}=await this.getGameMoves(l);if(t||!a.length)return{data:[],error:t};const c=[];if(a.length>0&&c.push({type:"first_move",moveNumber:1,description:"Game started",move:a[0]}),a.forEach((r,u)=>{u>0&&u%5===0&&c.push({type:"mid_game",moveNumber:r.move_number,description:`Move ${r.move_number}`,move:r})}),a.length>1){const r=a[a.length-1];c.push({type:"winning_move",moveNumber:r.move_number,description:"Winning move",move:r})}return{data:c,error:null}}};function Z(l){if(l<60)return`${l}s`;const a=Math.floor(l/60),t=l%60;if(a<60)return`${a}m ${t}s`;const c=Math.floor(a/60),r=a%60;return`${c}h ${r}m`}const ee=({gameId:l,onClose:a})=>{const[t,c]=p.useState(null),[r,u]=p.useState([]),[o,s]=p.useState(-1),[n,x]=p.useState(!1),[g,P]=p.useState(1),[$,w]=p.useState(!0),[z,N]=p.useState(Array(_).fill(null).map(()=>Array(_).fill(null))),[E,k]=p.useState({}),m=p.useRef(null);p.useEffect(()=>(I(),()=>{m.current&&clearInterval(m.current)}),[l]);const I=async()=>{w(!0);const[i,d]=await Promise.all([j.getReplaySummary(l),j.getGameMoves(l)]);i.data&&c(i.data),d.data&&u(d.data),w(!1)},v=i=>{if(i<0){N(Array(_).fill(null).map(()=>Array(_).fill(null))),k({});return}const d=r[i];d?.board_state&&(N(d.board_state.board||d.board_state),k(d.board_state.boardPieces||{}))},f=i=>{const d=Math.max(-1,Math.min(i,r.length-1));s(d),v(d),C.playClickSound("soft")},G=()=>{n?(x(!1),m.current&&(clearInterval(m.current),m.current=null)):(o>=r.length-1&&f(-1),x(!0),m.current=setInterval(()=>{s(i=>{const d=i+1;return d>=r.length?(x(!1),clearInterval(m.current),i):(v(d),C.playClickSound("soft"),d)})},1500/g))};p.useEffect(()=>{n&&m.current&&(clearInterval(m.current),m.current=setInterval(()=>{s(i=>{const d=i+1;return d>=r.length?(x(!1),clearInterval(m.current),i):(v(d),d)})},1500/g))},[g]);const q=async()=>{const i=j.getReplayLink(l);navigator.share?await navigator.share({title:"Deadblock Game Replay",text:`Watch this game between ${t?.player1?.username} and ${t?.player2?.username}!`,url:i}):(navigator.clipboard.writeText(i),alert("Replay link copied!"))},h=o>=0?r[o]:null;return $?e.jsx("div",{className:"fixed inset-0 bg-black/90 flex items-center justify-center z-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin w-12 h-12 border-3 border-amber-400 border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{className:"text-slate-400",children:"Loading replay..."})]})}):e.jsxs("div",{className:"fixed inset-0 bg-slate-950 flex flex-col z-50",children:[e.jsx("div",{className:"bg-slate-900 border-b border-amber-500/30 p-3",children:e.jsxs("div",{className:"flex items-center justify-between max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:a,className:"text-slate-400 hover:text-white",children:e.jsx(T,{size:24})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-amber-300 font-bold",children:"Game Replay"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-400",children:[e.jsx(A,{size:12}),t?.durationFormatted||"Unknown",e.jsx("span",{children:"â€¢"}),t?.moveCount||0," moves"]})]})]}),e.jsxs("button",{onClick:q,className:"flex items-center gap-2 px-3 py-1.5 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700",children:[e.jsx(L,{size:16}),"Share"]})]})}),e.jsx("div",{className:"bg-slate-900/50 p-3",children:e.jsxs("div",{className:"flex items-center justify-between max-w-md mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold",children:t?.player1?.username?.[0]||"?"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-white font-medium flex items-center gap-1",children:[t?.player1?.username,t?.winner_id===t?.player1?.id&&e.jsx(M,{size:14,className:"text-amber-400"})]}),e.jsx("div",{className:"text-xs text-slate-400",children:t?.player1?.elo_rating||1200})]})]}),e.jsx("div",{className:"text-slate-600 font-bold",children:"VS"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-white font-medium flex items-center gap-1 justify-end",children:[t?.winner_id===t?.player2?.id&&e.jsx(M,{size:14,className:"text-amber-400"}),t?.player2?.username]}),e.jsx("div",{className:"text-xs text-slate-400 text-right",children:t?.player2?.elo_rating||1200})]}),e.jsx("div",{className:"w-10 h-10 bg-gradient-to-br from-pink-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold",children:t?.player2?.username?.[0]||"?"})]})]})}),e.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:e.jsx("div",{className:"w-full max-w-md",children:e.jsx(B,{board:z,boardPieces:E,selectedPiece:null,pendingMove:null,currentPlayer:h?.player?.id===t?.player1?.id?1:2,onCellClick:()=>{},disabled:!0})})}),h&&e.jsx("div",{className:"bg-slate-900/50 p-2 text-center",children:e.jsxs("span",{className:"text-slate-400 text-sm",children:["Move ",h.move_number,":",e.jsxs("span",{className:h.player?.id===t?.player1?.id?"text-cyan-400":"text-pink-400",children:[" ",h.player?.username]})," ","placed ",h.piece_type]})}),e.jsx("div",{className:"px-4 py-2 bg-slate-900",children:e.jsxs("div",{className:"max-w-lg mx-auto",children:[e.jsx("input",{type:"range",min:"-1",max:r.length-1,value:o,onChange:i=>f(parseInt(i.target.value)),className:`w-full h-2 bg-slate-700 rounded-full appearance-none cursor-pointer
              [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 
              [&::-webkit-slider-thumb]:bg-amber-400 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer`}),e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 mt-1",children:[e.jsx("span",{children:"Start"}),e.jsxs("span",{children:["Move ",o+1," / ",r.length]}),e.jsx("span",{children:"End"})]})]})}),e.jsx("div",{className:"bg-slate-900 border-t border-amber-500/30 p-4",children:e.jsxs("div",{className:"flex items-center justify-center gap-3 max-w-lg mx-auto",children:[e.jsx("button",{onClick:()=>f(-1),className:"p-2 text-slate-400 hover:text-white disabled:opacity-50",disabled:o===-1,children:e.jsx(W,{size:20})}),e.jsx("button",{onClick:()=>f(o-1),className:"p-2 text-slate-400 hover:text-white disabled:opacity-50",disabled:o===-1,children:e.jsx(X,{size:20})}),e.jsx("button",{onClick:G,className:"p-4 bg-amber-500 text-slate-900 rounded-full hover:bg-amber-400",children:n?e.jsx(U,{size:24}):e.jsx(O,{size:24})}),e.jsx("button",{onClick:()=>f(o+1),className:"p-2 text-slate-400 hover:text-white disabled:opacity-50",disabled:o>=r.length-1,children:e.jsx(V,{size:20})}),e.jsx("button",{onClick:()=>f(r.length-1),className:"p-2 text-slate-400 hover:text-white disabled:opacity-50",disabled:o>=r.length-1,children:e.jsx(K,{size:20})}),e.jsxs("div",{className:"ml-4 flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-slate-500",children:"Speed:"}),[.5,1,2].map(i=>e.jsxs("button",{onClick:()=>P(i),className:`px-2 py-1 text-xs rounded ${g===i?"bg-amber-500 text-slate-900":"bg-slate-800 text-slate-400 hover:bg-slate-700"}`,children:[i,"x"]},i))]})]})})]})};export{ee as default};
