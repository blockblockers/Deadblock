import{$ as h}from"./index-8HZmLUul.js";const m=()=>{const a=JSON.parse(localStorage.getItem("sb-oyeibyrednwlolmsjlwk-auth-token")||"null"),t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95ZWlieXJlZG53bG9sbXNqbHdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMzMyNzQsImV4cCI6MjA4MDgwOTI3NH0.GNMI2HOyOn_YHPPgsrkinB5FipLedqo0bTN9PKRQJMY";return!a?.access_token||!t?null:{Authorization:`Bearer ${a.access_token}`,apikey:t,"Content-Type":"application/json"}},d="https://oyeibyrednwlolmsjlwk.supabase.co";class p{async getCurrentChallenge(){if(console.log("[WeeklyChallengeService] getCurrentChallenge called"),!h())return console.log("[WeeklyChallengeService] Supabase not configured"),{data:null,error:"Supabase not configured"};const a=m();if(!a)return console.log("[WeeklyChallengeService] No auth headers available"),{data:null,error:"Not authenticated"};try{console.log("[WeeklyChallengeService] Calling RPC via direct fetch...");const t=Date.now(),r=await fetch(`${d}/rest/v1/rpc/get_or_create_weekly_challenge`,{method:"POST",headers:a,body:JSON.stringify({})}),s=Date.now()-t;if(console.log("[WeeklyChallengeService] RPC completed in",s,"ms, status:",r.status),r.ok){const e=await r.json();if(console.log("[WeeklyChallengeService] Success! Challenge data:",e),e){const l=new Date,o=e.starts_at?new Date(e.starts_at):null,i=e.ends_at?new Date(e.ends_at):null;console.log("[WeeklyChallengeService] Challenge dates validation:",{now:l.toISOString(),starts_at:o?.toISOString(),ends_at:i?.toISOString(),week_number:e.week_number,challenge_id:e.id,puzzle_seed:e.puzzle_seed})}return{data:e,error:null}}const n=await r.text();return console.error("[WeeklyChallengeService] RPC error:",r.status,n),{data:null,error:`RPC failed: ${r.status}`}}catch(t){return console.error("[WeeklyChallengeService] Exception:",t),{data:null,error:t.message}}}async submitResult(a,t){if(!h())return{data:null,error:"Supabase not configured"};const r=m();if(!r)return{data:null,error:"Not authenticated"};const e=JSON.parse(localStorage.getItem("sb-oyeibyrednwlolmsjlwk-auth-token")||"null")?.user?.id;if(!e)return{data:null,error:"Not authenticated"};try{const l=await fetch(`${d}/rest/v1/weekly_challenge_results?user_id=eq.${e}&challenge_id=eq.${a}&select=*`,{headers:r});if(!l.ok)return{data:null,error:"Failed to check existing result"};const o=await l.json();if(o&&o.length>0){const i=o[0];if(t<(i.best_time_ms||1/0)){const g=await fetch(`${d}/rest/v1/weekly_challenge_results?id=eq.${i.id}`,{method:"PATCH",headers:{...r,Prefer:"return=representation"},body:JSON.stringify({best_time_ms:t,completed_at:new Date().toISOString()})});return{data:{...g.ok?(await g.json())[0]:i,is_improvement:!0,first_attempt_time_ms:i.first_attempt_time_ms,best_time_ms:t,was_first_attempt:!1},error:null}}else return{data:{...i,is_improvement:!1,was_first_attempt:!1},error:null}}else{const i=await fetch(`${d}/rest/v1/weekly_challenge_results`,{method:"POST",headers:{...r,Prefer:"return=representation"},body:JSON.stringify({user_id:e,challenge_id:a,first_attempt_time_ms:t,best_time_ms:t,completion_time_ms:t,completed_at:new Date().toISOString()})});return{data:{...i.ok?(await i.json())[0]:null,is_improvement:!0,first_attempt_time_ms:t,best_time_ms:t,was_first_attempt:!0},error:i.ok?null:"Failed to save result"}}}catch(l){return console.error("Error submitting weekly result:",l),{data:null,error:l.message}}}async getLeaderboard(a,t=50){if(console.log("[WeeklyChallengeService] getLeaderboard called:",{challengeId:a,limit:t}),!h())return{data:[],error:"Supabase not configured"};const r=m();if(!r)return{data:[],error:"Not authenticated"};try{const s=`${d}/rest/v1/weekly_challenge_results?challenge_id=eq.${a}&order=first_attempt_time_ms.asc.nullslast&limit=${t}&select=user_id,first_attempt_time_ms,best_time_ms,completion_time_ms,completed_at`,n=await fetch(s,{headers:r});if(!n.ok)return console.error("[WeeklyChallengeService] Results fetch failed:",n.status),{data:[],error:"Failed to fetch leaderboard"};const e=await n.json();if(e.length===0)return{data:[],error:null};const l=e.map(c=>c.user_id),o=`${d}/rest/v1/profiles?id=in.(${l.map(c=>`"${c}"`).join(",")})&select=id,username,display_name,rating`,i=await fetch(o,{headers:r});let u={};if(i.ok){const c=await i.json();u=Object.fromEntries(c.map(f=>[f.id,f]))}return{data:e.map((c,f)=>({...c,rank:f+1,profile:u[c.user_id]||{username:"Unknown",display_name:"Unknown"}})),error:null}}catch(s){return console.error("Error getting leaderboard:",s),{data:[],error:s.message}}}async getUserRank(a){if(!h())return{rank:null,error:"Not configured"};const s=JSON.parse(localStorage.getItem("sb-oyeibyrednwlolmsjlwk-auth-token")||"null")?.user?.id;if(!s)return{rank:null,error:"Not authenticated"};try{const{data:n}=await this.getLeaderboard(a,1e3),e=n.findIndex(l=>l.user_id===s);return e===-1?{rank:null,error:null}:{rank:e+1,error:null}}catch(n){return console.error("Error getting user rank:",n),{rank:null,error:n.message}}}async getUserChallengeStats(a){if(!h())return{data:null,error:"Supabase not configured"};const t=m();if(!t)return{data:null,error:"Not authenticated"};const n=JSON.parse(localStorage.getItem("sb-oyeibyrednwlolmsjlwk-auth-token")||"null")?.user?.id;if(!n)return{data:null,error:"Not authenticated"};try{const e=await fetch(`${d}/rest/v1/weekly_challenge_results?user_id=eq.${n}&challenge_id=eq.${a}&select=*`,{headers:t});if(!e.ok)return{data:null,error:"Failed to fetch stats"};const o=(await e.json())[0];return o?{data:{best_time:o.best_time_ms||o.first_attempt_time_ms||o.completion_time_ms,first_attempt_time:o.first_attempt_time_ms,attempts:o.attempts||1,completed_at:o.completed_at},error:null}:{data:null,error:null}}catch(e){return console.error("Error getting user challenge stats:",e),{data:null,error:e.message}}}async getUserPodiumCount(a){if(!h())return{data:0,error:"Not configured"};const t=m();if(!t)return{data:0,error:"Not authenticated"};try{const r=new Date().toISOString(),s=await fetch(`${d}/rest/v1/weekly_challenges?ends_at=lt.${r}&select=id`,{headers:t});if(!s.ok)return{data:0,error:"Failed to fetch challenges"};const n=await s.json();if(!n||n.length===0)return{data:0,error:null};let e=0;for(const l of n){const{data:o}=await this.getLeaderboard(l.id,10);if(o&&o.length>0){const i=o.findIndex(u=>u.user_id===a);i!==-1&&i<3&&e++}}return{data:e,error:null}}catch(r){return console.error("Error getting user podium count:",r),{data:0,error:r.message}}}async getUserPodiumBreakdown(a){if(!h())return{data:null,error:"Not configured"};const t=m();if(!t)return{data:null,error:"Not authenticated"};try{const r=new Date().toISOString(),s=await fetch(`${d}/rest/v1/weekly_challenges?ends_at=lt.${r}&select=id`,{headers:t});if(!s.ok)return console.log("[WeeklyChallengeService] Failed to fetch completed challenges"),{data:null,error:"Failed to fetch challenges"};const n=await s.json();if(!n||n.length===0)return console.log("[WeeklyChallengeService] No completed challenges found"),{data:{first:0,second:0,third:0,total:0},error:null};console.log("[WeeklyChallengeService] Processing",n.length,"completed challenges for podium breakdown");let e=0,l=0,o=0;for(const u of n){const{data:g}=await this.getLeaderboard(u.id,10);if(g&&g.length>0){const c=g.findIndex(f=>f.user_id===a);c===0?(e++,console.log("[WeeklyChallengeService] Found 1st place in challenge",u.id)):c===1?(l++,console.log("[WeeklyChallengeService] Found 2nd place in challenge",u.id)):c===2&&(o++,console.log("[WeeklyChallengeService] Found 3rd place in challenge",u.id))}}const i=e+l+o;return console.log("[WeeklyChallengeService] Podium breakdown:",{first:e,second:l,third:o,total:i}),{data:{first:e,second:l,third:o,total:i},error:null}}catch(r){return console.error("[WeeklyChallengeService] Error getting user podium breakdown:",r),{data:null,error:r.message}}}generatePuzzleSeed(a){return a?.puzzle_seed}formatTime(a){if(!a)return"--:--";const t=Math.floor(a/1e3),r=Math.floor(t/60),s=t%60,n=a%1e3;return r>0?`${r}:${s.toString().padStart(2,"0")}.${Math.floor(n/100)}`:`${t}.${Math.floor(n/100)}s`}getTimeRemaining(a){if(!a?.ends_at)return null;const t=new Date,s=new Date(a.ends_at)-t;if(s<=0)return{days:0,hours:0,minutes:0,expired:!0};const n=Math.floor(s/(1e3*60*60*24)),e=Math.floor(s%(1e3*60*60*24)/(1e3*60*60)),l=Math.floor(s%(1e3*60*60)/(1e3*60));return{days:n,hours:e,minutes:l,expired:!1}}}const w=new p;export{w};
