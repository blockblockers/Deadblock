var q=Object.defineProperty;var R=(g,e,t)=>e in g?q(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var _=(g,e,t)=>R(g,typeof e!="symbol"?e+"":e,t);import{m as p}from"./index-8HZmLUul.js";const D=p("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);class S{constructor(){_(this,"vibrationPatterns",{yourTurn:[100,50,100],gameInvite:[200,100,200,100,200],rematch:[150,75,150],chat:[50],victory:[100,50,100,50,300],defeat:[200,200,200],default:[100,50,100]});this.permission="default",this.initialized=!1,this.promptDismissed=!1}async init(){if(!this.initialized){if(!("Notification"in window)){console.log("[NotificationService] Browser does not support notifications"),this.permission="denied",this.initialized=!0;return}this.permission=Notification.permission,this.initialized=!0;try{this.promptDismissed=localStorage.getItem("deadblock_notification_prompt_dismissed")==="true"}catch{this.promptDismissed=!1}console.log("[NotificationService] Initialized with permission:",this.permission)}}isEnabled(){return this.permission==="granted"}isBlocked(){return this.permission==="denied"}isMobileDevice(){if(typeof window>"u")return!1;const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;return e||t&&window.innerWidth<=768}isDesktopBrowser(){return typeof window>"u"?!1:!this.isMobileDevice()}isPushSupported(){return!(!("Notification"in window)||!("serviceWorker"in navigator))}shouldPrompt(){return this.isPushSupported()&&this.permission==="default"&&!this.promptDismissed&&this.isMobileDevice()}dismissPrompt(){this.promptDismissed=!0;try{localStorage.setItem("deadblock_notification_prompt_dismissed","true")}catch{}}async requestPermission(){if(!("Notification"in window))return"denied";try{const e=await Notification.requestPermission();return this.permission=e,console.log("[NotificationService] Permission result:",e),e==="granted"&&this.sendNotification("Notifications Enabled",{body:"You will now receive notifications for game events!",tag:"deadblock-test",silent:!0}),e}catch(e){return console.error("[NotificationService] Permission request failed:",e),"denied"}}getNotificationIcon(e){return"/pwa-192x192.png"}getNotificationBadge(e){return{your_turn:"/badge-turn.svg",game_invite:"/badge-invite.svg",invite_accepted:"/badge-invite.svg",rematch_request:"/badge-rematch.svg",rematch_accepted:"/badge-rematch.svg",rematch_declined:"/badge-defeat.svg",chat_message:"/badge-chat.svg",victory:"/badge-victory.svg",defeat:"/badge-defeat.svg"}[e]||"/badge-default.svg"}sendNotification(e,t={}){if(!this.isEnabled())return console.log("[NotificationService] Notifications not enabled"),null;if(!document.hidden&&t.data?.type!=="chat_message")return console.log("[NotificationService] Page is visible, skipping notification"),null;try{const a=t.data?.type||"default",i={icon:this.getNotificationIcon(a),badge:this.getNotificationBadge(a),vibrate:this.vibrationPatterns[a]||this.vibrationPatterns.default,requireInteraction:t.requireInteraction||!1,silent:t.silent||!1,timestamp:Date.now(),...t};a==="game_invite"&&t.data?.inviteId?(i.actions=[{action:"accept",title:"✓ Accept",icon:"/pwa-192x192.png"},{action:"decline",title:"✗ Decline",icon:"/pwa-192x192.png"}],i.requireInteraction=!0):a==="rematch_request"&&t.data?.rematchId&&(i.actions=[{action:"accept",title:"⚔️ Rematch!",icon:"/pwa-192x192.png"},{action:"decline",title:"Not now",icon:"/pwa-192x192.png"}],i.requireInteraction=!0);const n=new Notification(e,i);return i.requireInteraction||setTimeout(()=>n.close(),1e4),n.onclick=o=>{o.preventDefault(),window.focus(),n.close();const s=t.data||{};let c="/";s.type==="chat_message"&&s.gameId?c=`/?navigateTo=online&gameId=${s.gameId}&openChat=true`:(s.type==="rematch_request"||s.type==="rematch_accepted")&&s.gameId?c=`/?navigateTo=online&gameId=${s.gameId}`:s.type==="your_turn"&&s.gameId?c=`/?navigateTo=online&gameId=${s.gameId}`:s.type==="game_invite"?c="/?navigateTo=online":s.type==="invite_accepted"&&s.gameId?c=`/?navigateTo=online&gameId=${s.gameId}`:s.gameId&&(c=`/?navigateTo=online&gameId=${s.gameId}`),console.log("[NotificationService] Click navigating to:",c,"type:",s.type),window.location.href=c},n}catch(a){return console.error("[NotificationService] Failed to send notification:",a),null}}getRandomMessage(e){return e[Math.floor(Math.random()*e.length)]}notifyYourTurn(e){const t=[`${e} made a move. It's your turn.`,`Your turn to play against ${e}.`,`${e} moved. Your turn now.`,`${e} just played. You're up!`,`Tag, you're it! ${e} made their move.`,`${e} is waiting for your move!`,`${e} threw down! Show them what you've got!`,`Move incoming from ${e}! Time to strike back!`,`ALERT: ${e} deployed their piece. Awaiting your response, operator.`,`[GRID UPDATED] ${e} made a power play. Your move, operator.`];return this.sendNotification("Deadblock - Your Turn!",{body:this.getRandomMessage(t),tag:"deadblock-turn",renotify:!0,data:{type:"your_turn"}})}notifyChatMessage(e,t,r){const a=t?.length>50?t.substring(0,50)+"...":t||"Sent a message";return this.sendNotification("Deadblock - New Message",{body:`${e}: ${a}`,tag:`deadblock-chat-${r}`,renotify:!0,data:{url:`/game/${r}`,gameId:r,type:"chat_message"}})}notifyRematchRequest(e,t,r){const a=[`${e} wants a rematch.`,`${e} requested a rematch.`,`Rematch request from ${e}.`,`${e} wants another round!`,`${e} isn't done yet! Rematch?`,`Think you can beat ${e} again? They want a rematch!`,`${e} demands a rematch! Are you ready?!`,`Round 2? ${e} is calling you out!`,`[INCOMING CHALLENGE] ${e} requests grid re-engagement.`,`${e} jacked back in. They want revenge, choom.`];return this.sendNotification("Deadblock - Rematch Request",{body:this.getRandomMessage(a),tag:`deadblock-rematch-${r}`,renotify:!0,requireInteraction:!0,data:{url:`/game/${t}`,gameId:t,rematchId:r,type:"rematch_request"}})}notifyRematchAccepted(e,t){const r=[`${e} accepted. New game starting.`,`${e} accepted your rematch.`,`Rematch accepted by ${e}. Game ready.`,`${e} is ready for round two!`,`Game on! ${e} accepted your rematch.`,`${e} said yes! Let's go again!`,`${e} accepted! Time to settle the score!`,`IT'S ON! ${e} wants that rematch!`,`[REMATCH CONFIRMED] ${e} re-entering the grid. Prepare for battle.`,`${e} accepted the challenge. Jack in and dominate, operator.`];return this.sendNotification("Deadblock - Rematch Accepted!",{body:this.getRandomMessage(r),tag:`deadblock-rematch-accepted-${t}`,renotify:!0,data:{url:`/game/${t}`,gameId:t,type:"rematch_accepted"}})}notifyRematchDeclined(e){const t=[`${e} declined your rematch.`,`${e} passed on the rematch.`,`Rematch declined by ${e}.`,`${e} isn't up for another game right now.`,`${e} said not this time.`,`Maybe later? ${e} declined the rematch.`,`${e} has other plans. No rematch for now.`,`${e} stepped away from the challenge.`,`[REQUEST DENIED] ${e} disconnected from rematch protocol.`,`${e} flatlined your rematch request. Find a new target.`];return this.sendNotification("Deadblock - Rematch Declined",{body:this.getRandomMessage(t),tag:"deadblock-rematch-declined",renotify:!0,data:{type:"rematch_declined"}})}notifyGameInvite(e,t){const r=[`${e} challenged you to a game.`,`New game invite from ${e}.`,`${e} wants to play.`,`${e} is looking for competition. You in?`,`${e} threw down the gauntlet!`,`Ready to play? ${e} is waiting!`,`${e} just challenged you! Accept and dominate!`,`CHALLENGE INCOMING! ${e} thinks they can beat you!`,`[PRIORITY ALERT] ${e} initiated grid challenge. Respond, operator.`,`${e} is breaking into your schedule. Game invite received, choom.`];return this.sendNotification("Deadblock - Game Invite",{body:this.getRandomMessage(r),tag:`deadblock-invite-${t}`,renotify:!0,requireInteraction:!0,data:{url:"/online",inviteId:t,type:"game_invite"}})}notifyInviteAccepted(e,t){const r=[`${e} accepted. Game starting.`,`${e} accepted your invite.`,`Your challenge was accepted by ${e}.`,`${e} is ready to play! Let's go!`,`Game on! ${e} accepted your challenge.`,`${e} joined the game. Show them what you've got!`,`${e} accepted your challenge! Time to battle!`,`LET'S GO! ${e} is ready to face you!`,`[OPPONENT LOCKED] ${e} connected to the grid. Initiating game sequence.`,`${e} jacked in. The digital arena awaits, operator.`];return this.sendNotification("Deadblock - Invite Accepted",{body:this.getRandomMessage(r),tag:`deadblock-game-${t}`,renotify:!0,data:{url:`/game/${t}`,gameId:t,type:"invite_accepted"}})}notifyGameOver(e,t){const r=[`You beat ${t}.`,`Victory against ${t}.`,`You won the game vs ${t}.`,`Nice one! You defeated ${t}!`,`${t} couldn't handle it. You win!`,`GG! You took down ${t}!`,`CRUSHING VICTORY! ${t} didn't stand a chance!`,`DOMINANT WIN! You destroyed ${t}!`,`[TARGET ELIMINATED] ${t} has been flatlined. Victory achieved.`,`You fried ${t}'s circuits. Another win for the operator.`],a=[`${t} won the game.`,`You lost to ${t}.`,`Game over. ${t} wins.`,`Tough break. ${t} got you this time.`,`${t} was on fire! Better luck next time.`,`So close! ${t} edged you out.`,`${t} won. but you've got next game!`,`Defeat today, victory tomorrow. ${t} wins this round.`,`[SYSTEM FAILURE] ${t} hacked your strategy. Reboot and try again.`,`${t} pulled the plug. Time to upgrade your tactics, choom.`],i=e?"Deadblock - Victory!":"Deadblock - Game Over",n=e?r:a,o=e?"victory":"defeat";return this.sendNotification(i,{body:this.getRandomMessage(n),tag:"deadblock-gameover",renotify:!0,data:{type:o}})}}const M=new S,h="https://oyeibyrednwlolmsjlwk.supabase.co",$="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95ZWlieXJlZG53bG9sbXNqbHdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMzMyNzQsImV4cCI6MjA4MDgwOTI3NH0.GNMI2HOyOn_YHPPgsrkinB5FipLedqo0bTN9PKRQJMY",w="sb-oyeibyrednwlolmsjlwk-auth-token",y=()=>{const g=JSON.parse(localStorage.getItem(w)||"null");return!g?.access_token||!$?null:{Authorization:`Bearer ${g.access_token}`,apikey:$,"Content-Type":"application/json",Prefer:"return=representation"}};class I{constructor(){this.subscriptions=new Map}async createRematchRequest(e,t,r){const a=y();if(!a)return{data:null,error:{message:"Not authenticated"}};try{const i=`${h}/rest/v1/rematch_requests?game_id=eq.${e}&status=eq.pending&select=*`,n=await fetch(i,{headers:a});if(n.ok){const u=await n.json();if(u&&u.length>0){const l=u[0];if(l.from_user_id===r)return await this.acceptRematchRequest(l.id,t);if(l.from_user_id===t)return{data:l,error:null}}}const o=Math.random()<.5?t:r,s={game_id:e,from_user_id:t,to_user_id:r,first_player_id:o,status:"pending"},c=`${h}/rest/v1/rematch_requests`,m=await fetch(c,{method:"POST",headers:a,body:JSON.stringify(s)});if(!m.ok){const u=await m.text();return console.error("[RematchService] Failed to create request:",u),{data:null,error:{message:"Failed to create rematch request"}}}const f=await m.json();return{data:Array.isArray(f)?f[0]:f,error:null}}catch(i){return console.error("[RematchService] Create error:",i),{data:null,error:{message:i.message}}}}async getPendingRematchRequest(e,t){const r=y();if(!r)return{data:null,error:null};try{const a=`${h}/rest/v1/rematch_requests?game_id=eq.${e}&status=eq.pending&or=(from_user_id.eq.${t},to_user_id.eq.${t})&select=*&order=created_at.desc&limit=1`,i=await fetch(a,{headers:r});return i.ok?{data:(await i.json())[0]||null,error:null}:{data:null,error:null}}catch(a){return console.error("[RematchService] Get pending error:",a),{data:null,error:{message:a.message}}}}async getRematchRequestByGame(e,t){const r=y();if(!r)return{data:null,error:null};try{const a=`${h}/rest/v1/rematch_requests?game_id=eq.${e}&or=(from_user_id.eq.${t},to_user_id.eq.${t})&select=*&order=created_at.desc&limit=1`,i=await fetch(a,{headers:r});return i.ok?{data:(await i.json())[0]||null,error:null}:{data:null,error:null}}catch(a){return console.error("[RematchService] Get request by game error:",a),{data:null,error:{message:a.message}}}}async getPendingRematchRequests(e){const t=y();if(!t)return{data:[],error:{message:"Not authenticated"}};try{const r=`${h}/rest/v1/rematch_requests?or=(from_user_id.eq.${e},to_user_id.eq.${e})&status=eq.pending&order=created_at.desc`,a=await fetch(r,{headers:t});if(!a.ok)return console.error("[RematchService] Failed to fetch rematch requests"),{data:[],error:{message:"Failed to fetch rematch requests"}};const i=await a.json();if(!i||i.length===0)return{data:[],error:null};const n=i.map(s=>s.from_user_id===e?s.to_user_id:s.from_user_id).filter(Boolean),o=[...new Set(n)];if(o.length>0){const s=`${h}/rest/v1/profiles?id=in.(${o.join(",")})&select=id,username,display_name`,c=await fetch(s,{headers:t});if(c.ok){const m=await c.json(),f={};m.forEach(d=>{f[d.id]=d}),i.forEach(d=>{const u=d.from_user_id===e?d.to_user_id:d.from_user_id,l=f[u];d.opponent_id=u,d.opponent_name=l?.display_name||l?.username||"Opponent",d.is_sender=d.from_user_id===e})}}return{data:i,error:null}}catch(r){return console.error("[RematchService] Get pending requests error:",r),{data:[],error:{message:r.message}}}}async acceptRematchRequest(e,t){const r=y();if(!r)return{data:null,error:{message:"Not authenticated"}};try{const a=`${h}/rest/v1/rematch_requests?id=eq.${e}&select=*`,i=await fetch(a,{headers:r});if(!i.ok)return{data:null,error:{message:"Request not found"}};const o=(await i.json())[0];if(!o)return{data:null,error:{message:"Request not found"}};if(o.status!=="pending")return{data:null,error:{message:"Request already processed"}};const s=o.first_player_id,c=o.first_player_id===o.from_user_id?o.to_user_id:o.from_user_id,m=Array(8).fill(null).map(()=>Array(8).fill(0)),f={player1_id:s,player2_id:c,board:m,board_pieces:{},used_pieces:[],current_player:1,status:"active"},d=await fetch(`${h}/rest/v1/games`,{method:"POST",headers:r,body:JSON.stringify(f)});if(!d.ok){const b=await d.text();return console.error("[RematchService] Failed to create game:",b),{data:null,error:{message:"Failed to create new game"}}}const u=await d.json(),l=Array.isArray(u)?u[0]:u,v=`${h}/rest/v1/rematch_requests?id=eq.${e}`;return await fetch(v,{method:"PATCH",headers:{...r,Prefer:"return=minimal"},body:JSON.stringify({status:"accepted",new_game_id:l.id,updated_at:new Date().toISOString()})}),{data:{request:{...o,status:"accepted",new_game_id:l.id},game:l,firstPlayerId:s},error:null}}catch(a){return console.error("[RematchService] Accept error:",a),{data:null,error:{message:a.message}}}}async declineRematchRequest(e,t){const r=y();if(!r)return{data:null,error:{message:"Not authenticated"}};try{const a=`${h}/rest/v1/rematch_requests?id=eq.${e}`,i=await fetch(a,{method:"PATCH",headers:r,body:JSON.stringify({status:"declined",updated_at:new Date().toISOString()})});if(!i.ok)return{data:null,error:{message:"Failed to decline request"}};const n=await i.json();return{data:Array.isArray(n)?n[0]:null,error:null}}catch(a){return console.error("[RematchService] Decline error:",a),{data:null,error:{message:a.message}}}}async cancelRematchRequest(e,t){const r=y();if(!r)return{data:null,error:{message:"Not authenticated"}};try{const a=`${h}/rest/v1/rematch_requests?id=eq.${e}&from_user_id=eq.${t}`;return(await fetch(a,{method:"PATCH",headers:r,body:JSON.stringify({status:"cancelled",updated_at:new Date().toISOString()})})).ok?{data:{cancelled:!0},error:null}:{data:null,error:{message:"Failed to cancel request"}}}catch(a){return console.error("[RematchService] Cancel error:",a),{data:null,error:{message:a.message}}}}subscribeToRematchUpdates(e,t,r){if(!JSON.parse(localStorage.getItem(w)||"null")?.access_token)return()=>{};let i=null,n=null;const o=setInterval(async()=>{const{data:s}=await this.getRematchRequestByGame(e,t);if(s){const c=s.status!==i,m=s.new_game_id&&s.new_game_id!==n;(c||m)&&(i=s.status,n=s.new_game_id,r(s))}else i!==null&&(i=null,n=null,r(null))},2e3);return this.subscriptions.set(e,o),()=>{clearInterval(o),this.subscriptions.delete(e)}}async checkRematchStatus(e,t){const{data:r}=await this.getPendingRematchRequest(e,t);return r?{hasPending:!0,isSender:r.from_user_id===t,request:r}:{hasPending:!1,isSender:!1,request:null}}}const P=new I;export{D as S,M as n,P as r};
