import{a6 as l,a7 as A,q as B,u as G,r as c,j as e,N as z,T as O,X as U,Z as X,s as k}from"./index-8HZmLUul.js";import{F as L}from"./FloatingPieces-CkGA4VAV.js";import{S as Z}from"./search-2i7mNli-.js";import{A as D}from"./alert-circle-DwjqkFl6.js";class V{constructor(){this.unsubscribeHandler=null,this.pollingInterval=null}async joinQueue(a,r){if(!l)return{error:{message:"Not configured"}};await this.leaveQueue(a);const{data:t,error:s}=await l.from("matchmaking_queue").insert({user_id:a,rating:r||1e3,status:"waiting"}).select().single();return{data:t,error:s}}async leaveQueue(a){if(!l)return{error:null};const{error:r}=await l.from("matchmaking_queue").delete().eq("user_id",a);return{error:r}}async findMatch(a,r,t=300){if(!l)return null;const{data:s,error:n}=await l.from("matchmaking_queue").select("*").eq("status","waiting").neq("user_id",a).gte("rating",r-t).lte("rating",r+t).order("queued_at",{ascending:!0}).limit(1);return n?(console.error("Error finding match:",n),null):s&&s.length>0?s[0]:null}async createGame(a,r){if(!l)return{error:{message:"Not configured"}};const t=Array(8).fill(null).map(()=>Array(8).fill(null)),s=Math.random()<.5?1:2;console.log("Creating game between",a,"and",r);try{const{data:n,error:i}=await l.from("games").insert({player1_id:a,player2_id:r,board:t,board_pieces:{},used_pieces:[],current_player:s,status:"active"}).select().single();if(i)return console.error("Error creating game:",i),{game:null,error:i};console.log("Game created:",n.id);const{data:m,error:d}=await l.from("games").select(`
          *,
          player1:profiles!games_player1_id_fkey(*),
          player2:profiles!games_player2_id_fkey(*)
        `).eq("id",n.id).single();return d?(console.error("Error fetching game with profiles:",d),{game:n,error:null}):(await l.from("matchmaking_queue").delete().in("user_id",[a,r]),console.log("Game ready with profiles:",m.id),{game:m,error:null})}catch(n){return console.error("Exception creating game:",n),{game:null,error:{message:n.message||"Unknown error"}}}}startMatchmaking(a,r,t,s){return this.stopMatchmaking(),this.pollingInterval=setInterval(async()=>{try{const{data:n}=await l.from("matchmaking_queue").select("*").eq("user_id",a).eq("status","waiting").single();if(!n){this.stopMatchmaking();return}const i=await this.findMatch(a,r);if(i){const{game:m,error:d}=await this.createGame(a,i.user_id);d?(console.error("Error creating game:",d),s?.(d)):m&&(this.stopMatchmaking(),t(m))}}catch(n){console.error("Matchmaking error:",n),s?.(n)}},2e3),()=>this.stopMatchmaking()}subscribeToMatches(a,r){return l?(console.log("[Matchmaking] Subscribing to matches via RealtimeManager"),this.unsubscribeHandler=A.on("matchFound",async t=>{console.log("[Matchmaking] Match found via RealtimeManager:",t?.id);const{data:s}=await l.from("games").select(`
          *,
          player1:profiles!games_player1_id_fkey(*),
          player2:profiles!games_player2_id_fkey(*)
        `).eq("id",t.id).single();s&&(this.stopMatchmaking(),r(s))}),{unsubscribe:()=>{this.unsubscribeHandler&&(this.unsubscribeHandler(),this.unsubscribeHandler=null)}}):{unsubscribe:()=>{}}}stopMatchmaking(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.unsubscribeHandler&&(this.unsubscribeHandler(),this.unsubscribeHandler=null)}async getQueueStatus(){if(!l)return{count:0};const{count:a}=await l.from("matchmaking_queue").select("*",{count:"exact",head:!0}).eq("status","waiting");return{count:a||0}}}const b=new V,u={gridColor:"rgba(251,191,36,0.4)",glow1:{color:"bg-amber-500/40",pos:"top-1/3 left-1/4"},glow2:{color:"bg-orange-500/35",pos:"bottom-1/3 right-1/4"},cardBg:"bg-gradient-to-br from-slate-900/95 via-amber-950/40 to-slate-900/95",cardBorder:"border-amber-500/40",cardShadow:"shadow-[0_0_60px_rgba(251,191,36,0.3),inset_0_0_20px_rgba(251,191,36,0.05)]"},ee=({onMatchFound:_,onCancel:a})=>{const{user:r,profile:t}=B(),{needsScroll:s}=G(700),[n,i]=c.useState("idle"),[m,d]=c.useState(0),[E,T]=c.useState(0),[$,g]=c.useState(""),[M,w]=c.useState(0),[h,F]=c.useState(null),j=c.useRef(null),x=c.useRef(null),p=c.useRef(null);c.useEffect(()=>(q(),()=>{S()}),[]);const S=()=>{j.current&&(clearInterval(j.current),j.current=null),p.current&&(clearInterval(p.current),p.current=null),x.current&&(x.current(),x.current=null),b.stopMatchmaking(),r?.id&&b.leaveQueue(r.id)},q=async()=>{if(!r||!t){g("Not logged in");return}i("searching"),g(""),d(0);const{error:v}=await b.joinQueue(r.id,t.rating||1e3);if(v){g("Failed to join queue: "+v.message),i("error");return}j.current=setInterval(()=>{d(o=>o+1)},1e3);const y=async()=>{const{count:o}=await b.getQueueStatus();T(o)};y();const f=setInterval(y,5e3),I=o=>{if(!o||!o.id){console.error("Invalid game received:",o),g("Failed to create game. Please try again."),i("error"),clearInterval(f);return}F(o),i("found"),k.playSound("win"),clearInterval(f),w(0);let N=0;p.current=setInterval(()=>{N+=5,w(Math.min(N,95)),N>=100&&clearInterval(p.current)},50),setTimeout(()=>{w(100),setTimeout(()=>{_(o)},200)},1200)},P=o=>{console.error("Matchmaking error:",o),g(o?.message||"An error occurred. Please try again."),i("error"),clearInterval(f)};x.current=b.startMatchmaking(r.id,t.rating||1e3,I,P),b.subscribeToMatches(r.id,I);const H=x.current;x.current=()=>{H?.(),clearInterval(f)}},C=()=>{k.playButtonClick(),S(),a()},Q=()=>{k.playButtonClick(),g(""),q()},R=v=>{const y=Math.floor(v/60),f=v%60;return`${y}:${f.toString().padStart(2,"0")}`};return e.jsxs("div",{className:s?"min-h-screen bg-slate-950":"h-screen bg-slate-950 overflow-hidden",style:s?{overflowY:"auto",overflowX:"hidden",WebkitOverflowScrolling:"touch",touchAction:"pan-y"}:{},children:[e.jsx("div",{className:"fixed inset-0 opacity-40 pointer-events-none",style:{backgroundImage:`linear-gradient(${u.gridColor} 1px, transparent 1px), linear-gradient(90deg, ${u.gridColor} 1px, transparent 1px)`,backgroundSize:"40px 40px",animation:"gridMove 20s linear infinite"}}),e.jsx("div",{className:`fixed ${u.glow1.pos} w-80 h-80 ${u.glow1.color} rounded-full blur-3xl pointer-events-none animate-pulse`}),e.jsx("div",{className:`fixed ${u.glow2.pos} w-80 h-80 ${u.glow2.color} rounded-full blur-3xl pointer-events-none animate-pulse`,style:{animationDelay:"1s"}}),e.jsx(L,{count:12,theme:"online",minOpacity:.2,maxOpacity:.4}),e.jsxs("div",{className:`relative ${s?"min-h-screen":"h-full"} flex flex-col items-center justify-center px-4 ${s?"py-8":"py-4"}`,children:[e.jsxs("div",{className:"w-full max-w-md text-center",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx(z,{size:"large"}),e.jsx("p",{className:"text-amber-400/80 text-sm mt-2 font-medium",children:"Online Matchmaking"})]}),e.jsxs("div",{className:`${u.cardBg} backdrop-blur-md rounded-2xl p-8 border ${u.cardBorder} ${u.cardShadow}`,children:[n==="searching"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative w-24 h-24 mx-auto mb-6",children:[e.jsx("div",{className:"absolute inset-0 border-4 border-amber-500/30 rounded-full animate-ping"}),e.jsx("div",{className:"absolute inset-2 border-4 border-amber-400/50 rounded-full animate-pulse"}),e.jsx("div",{className:"absolute inset-4 border-4 border-transparent border-t-amber-400 rounded-full animate-spin"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(Z,{size:28,className:"text-amber-300"})})]}),e.jsx("h2",{className:"text-2xl font-bold text-amber-300 mb-2",children:"Finding Opponent..."}),e.jsx("p",{className:"text-slate-400 mb-6",children:"Searching for players near your skill level"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/50",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:R(m)}),e.jsx("div",{className:"text-xs text-slate-500",children:"Search Time"})]}),e.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3 border border-slate-700/50",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:E}),e.jsx("div",{className:"text-xs text-slate-500",children:"In Queue"})]})]}),e.jsxs("div",{className:"bg-slate-800/30 rounded-lg p-4 mb-6 flex items-center justify-between border border-slate-700/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center text-white font-bold",children:t?.username?.[0]?.toUpperCase()||"?"}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-white font-medium",children:t?.username||"Player"}),e.jsxs("div",{className:"text-slate-500 text-xs",children:["Rating: ",t?.rating||1e3]})]})]}),e.jsx(O,{size:20,className:"text-amber-400"})]}),e.jsxs("button",{onClick:C,className:"w-full py-3 bg-slate-800 border border-slate-700 text-slate-300 rounded-lg hover:bg-slate-700 hover:text-white transition-all flex items-center justify-center gap-2",children:[e.jsx(U,{size:18}),"Cancel Search"]})]}),n==="found"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative w-24 h-24 mx-auto mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-green-500/30 rounded-full animate-ping"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gradient-to-br from-green-500 to-emerald-600 rounded-full shadow-[0_0_30px_rgba(34,197,94,0.6)]",children:e.jsx(X,{size:36,className:"text-white"})})]}),e.jsx("h2",{className:"text-3xl font-black text-green-400 mb-2",children:"MATCH FOUND!"}),e.jsx("p",{className:"text-slate-400 mb-6",children:"Preparing your game..."}),e.jsxs("div",{className:"w-full mb-4",children:[e.jsx("div",{className:"h-3 bg-slate-800 rounded-full overflow-hidden border border-slate-700",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-green-500 to-emerald-400 rounded-full transition-all duration-100 ease-out relative",style:{width:`${M}%`},children:e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shimmer"})})}),e.jsxs("div",{className:"text-xs text-slate-500 mt-2",children:[M,"%"]})]}),h&&e.jsxs("div",{className:"bg-slate-800/30 rounded-lg p-4 flex items-center justify-center gap-4 border border-slate-700/50",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-10 h-10 mx-auto rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center text-white font-bold mb-1",children:t?.username?.[0]?.toUpperCase()||"?"}),e.jsx("div",{className:"text-white text-xs font-medium",children:t?.username})]}),e.jsx("div",{className:"text-2xl font-black text-slate-600",children:"VS"}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-10 h-10 mx-auto rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-white font-bold mb-1",children:(h.player1?.id===r?.id?h.player2?.username?.[0]:h.player1?.username?.[0])?.toUpperCase()||"?"}),e.jsx("div",{className:"text-white text-xs font-medium",children:h.player1?.id===r?.id?h.player2?.username:h.player1?.username})]})]})]}),n==="error"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative w-20 h-20 mx-auto mb-6",children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-red-900/50 rounded-full border-2 border-red-500/50",children:e.jsx(D,{size:36,className:"text-red-400"})})}),e.jsx("h2",{className:"text-2xl font-bold text-red-400 mb-2",children:"Connection Error"}),e.jsx("p",{className:"text-slate-400 mb-6",children:$||"Something went wrong. Please try again."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:C,className:"flex-1 py-3 bg-slate-800 border border-slate-700 text-slate-300 rounded-lg hover:bg-slate-700 hover:text-white transition-all",children:"Back"}),e.jsx("button",{onClick:Q,className:"flex-1 py-3 bg-amber-600 text-white rounded-lg hover:bg-amber-500 transition-all font-bold",children:"Retry"})]})]})]}),n==="searching"&&e.jsx("div",{className:"mt-6 text-slate-500 text-sm",children:e.jsx("p",{children:"ðŸ’¡ Tip: Games typically match within 30 seconds during peak hours"})})]}),s&&e.jsx("div",{className:"h-8 flex-shrink-0"})]}),e.jsx("style",{children:`
        @keyframes gridMove {
          0% { transform: translate(0, 0); }
          100% { transform: translate(40px, 40px); }
        }
        @keyframes shimmer {
          0% { transform: translateX(-100%); }
          100% { transform: translateX(200%); }
        }
        .animate-shimmer {
          animation: shimmer 1s ease-in-out infinite;
        }
      `})]})};export{ee as default};
